{% comment %}
  Shopify Liquid Snippet: Set Loyalty Cookies Server-Side

  Installation:
  1. Add this snippet to your theme (Snippets folder)
  2. Include it in your theme.liquid or account page templates:
     {% render 'loyalty-cookie-liquid-snippet' %}

  This will make a server-side API call and set cookies via JavaScript
{% endcomment %}

{% if customer %}
<script>
(function() {
  'use strict';

  // Cookie utility function
  function setCookie(name, value, days) {
    var expires = "";
    if (days) {
      var date = new Date();
      date.setTime(date.getTime() + (days * 24 * 60 * 60 * 1000));
      expires = "; expires=" + date.toUTCString();
    }
    document.cookie = name + "=" + (value || "") + expires + "; path=/; SameSite=Lax";
  }

  function getCookie(name) {
    var nameEQ = name + "=";
    var ca = document.cookie.split(';');
    for(var i = 0; i < ca.length; i++) {
      var c = ca[i];
      while (c.charAt(0) == ' ') c = c.substring(1, c.length);
      if (c.indexOf(nameEQ) == 0) return c.substring(nameEQ.length, c.length);
    }
    return null;
  }

  // Check if cookies already exist and are fresh (less than 1 day old)
  var existingMember = getCookie('loyalty_member');
  var existingTier = getCookie('loyalty_tier');
  var lastFetch = getCookie('loyalty_last_fetch');
  var now = new Date().getTime();

  // Only fetch if cookies don't exist or are older than 24 hours
  if (existingMember && existingTier && lastFetch && (now - parseInt(lastFetch)) < 86400000) {
    console.log('Using cached loyalty data');
    return;
  }

  // Customer data from Shopify Liquid
  var customerId = {{ customer.id | json }};
  var customerEmail = {{ customer.email | json }};

  console.log('Fetching loyalty data for customer:', customerId);

  // Use Shopify App Proxy or your backend endpoint here
  // This should be YOUR server endpoint that calls the VFC API
  var proxyUrl = '/apps/loyalty-proxy?customer_id=' + customerId;

  // Alternative: If you can't use proxy, push to dataLayer for server-side GTM
  window.dataLayer = window.dataLayer || [];
  window.dataLayer.push({
    'event': 'requestLoyaltyData',
    'customer_id': customerId,
    'customer_email': customerEmail
  });

  console.log('Loyalty data request pushed to dataLayer for server-side processing');

})();
</script>

{% comment %}
  Fallback: Set basic cookies from Shopify customer data
  This ensures cookies are always set, even without API call
{% endcomment %}
<script>
(function() {
  // Set basic customer status cookies
  document.cookie = 'customer_logged_in=true; path=/; max-age=' + (30*24*60*60) + '; SameSite=Lax';
  document.cookie = 'customer_id={{ customer.id }}; path=/; max-age=' + (30*24*60*60) + '; SameSite=Lax';
  document.cookie = 'customer_email={{ customer.email }}; path=/; max-age=' + (30*24*60*60) + '; SameSite=Lax';

  // Push to dataLayer
  window.dataLayer = window.dataLayer || [];
  window.dataLayer.push({
    'event': 'customerDataAvailable',
    'customer_id': {{ customer.id | json }},
    'customer_email': {{ customer.email | json }},
    'customer_logged_in': true
  });
})();
</script>

{% else %}
<script>
(function() {
  // Customer not logged in - set default values
  document.cookie = 'customer_logged_in=false; path=/; max-age=' + (30*24*60*60) + '; SameSite=Lax';
  document.cookie = 'loyalty_member=false; path=/; max-age=' + (30*24*60*60) + '; SameSite=Lax';
  document.cookie = 'loyalty_tier=None; path=/; max-age=' + (30*24*60*60) + '; SameSite=Lax';

  window.dataLayer = window.dataLayer || [];
  window.dataLayer.push({
    'event': 'customerDataAvailable',
    'customer_logged_in': false
  });
})();
</script>
{% endif %}
