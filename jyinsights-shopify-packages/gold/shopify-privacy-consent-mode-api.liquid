{% comment %}
/**
 * JY Insights - Shopify Privacy API + Consent Mode Integration
 * Version: 2.2 (GPC Compliance & CPRA Best Practices)
 * Last Updated: 2026-01-20
 *
 * KEY UPDATES IN v2.2:
 * - GPC correctly allows analytics while blocking sale/sharing only (CPRA compliant)
 * - ad_user_data and ad_personalization now follow sale_of_data (not marketing)
 * - GPC checked on EVERY consent update (persistent override)
 * - Improved dataLayer events with GPC state tracking
 * - sessionStorage includes GPC status for checkout pixel
 *
 * FEATURES:
 * - Reads from Shopify.customerPrivacy.currentVisitorConsent() API
 * - Maps marketing consent → sale_of_data (configurable)
 * - GPC/DNT honored as immutable override for sale/sharing
 * - Google Consent Mode v2 via gtag()
 * - sessionStorage for checkout pixel
 * - Event-driven + optional polling
 *
 * GPC BEHAVIOR (CPRA Compliant):
 * - GPC ONLY blocks: sale_of_data, ad_user_data, ad_personalization
 * - GPC does NOT block: analytics_storage (first-party analytics allowed)
 * - GPC checked on every consent update (not just init)
 * - GPC overrides banner choices for sale/sharing
 *
 * CONSENT MAPPING:
 * - analytics → analytics_storage
 * - marketing → ad_storage
 * - sale_of_data → ad_user_data, ad_personalization (GPC override applies)
 * - preferences → personalization_storage
 *
 * SHOPIFY API ALIGNMENT:
 * - When saleOfDataFollowsMarketing=true: marketing='yes' → internal sale_of_data=true
 * - Shopify's raw sale_of_data may be '' (empty) - this is expected
 * - Apps calling saleOfDataAllowed() will return true when sale_of_data=''
 * - Our internal mapping ensures Google Consent Mode gets correct values
 *
 * REQUIREMENTS:
 * 1. Add loadFeatures script BEFORE this in theme.liquid:
 *    <script>
 *      if (window.Shopify && window.Shopify.loadFeatures) {
 *        window.Shopify.loadFeatures([{
 *          name: 'consent-tracking-api',
 *          version: '0.1'
 *        }]);
 *      }
 *    </script>
 *
 * 2. Render this snippet in theme.liquid
 *
 * CONFIGURATION:
 * - saleOfDataFollowsMarketing: true = marketing → sale_of_data (standard)
 * - pollingInterval: milliseconds (0 to disable)
 * - debug: true/false
 */
{% endcomment %}

<script type="text/javascript">
(function() {
  'use strict';

  // ==========================================================================
  // CONFIGURATION
  // ==========================================================================

  var CONFIG = {
    debug: true,
    version: '2.2',

    // When true: marketing consent → sale_of_data
    // Standard for cross-context behavioral advertising under CPRA
    saleOfDataFollowsMarketing: true,

    // Shopify consent event
    consentEvent: 'visitorConsentCollected',

    // Polling interval (ms) - 0 to disable
    pollingInterval: 2000,

    defaultConsent: {
      analytics_storage: 'denied',
      ad_storage: 'denied',
      ad_user_data: 'denied',
      ad_personalization: 'denied',
      personalization_storage: 'denied',
      functionality_storage: 'granted',
      security_storage: 'granted'
    }
  };

  var lastConsentState = null;
  var consentInitialized = false;

  // ==========================================================================
  // IMMEDIATE CONSENT INITIALIZATION (before GTM loads)
  // ==========================================================================

  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}

  // Set consent defaults immediately
  gtag('consent', 'default', Object.assign({}, CONFIG.defaultConsent, {
    wait_for_update: 500
  }));

  window.dataLayer.push({
    event: 'consent_default',
    consent_state: CONFIG.defaultConsent,
    analytics_consent: false,
    marketing_consent: false,
    preferences_consent: false,
    sale_of_data_consent: false,
    consent_source: 'default'
  });

  // Initialize sessionStorage for checkout pixel
  try {
    if (!sessionStorage.getItem('jy_consent_state')) {
      sessionStorage.setItem('jy_consent_state', JSON.stringify({
        analytics: false,
        marketing: false,
        preferences: false,
        sale_of_data: false,
        gpc_active: false,
        timestamp: Date.now(),
        source: 'default'
      }));
    }
  } catch (e) {}

  // ==========================================================================
  // LOGGING
  // ==========================================================================

  function log() {
    if (CONFIG.debug && typeof console !== 'undefined') {
      console.log('[Consent v' + CONFIG.version + ']', Array.prototype.slice.call(arguments).join(' '));
    }
  }

  // ==========================================================================
  // GPC DETECTION
  // ==========================================================================

  /**
   * Check for Global Privacy Control or Do Not Track signals
   *
   * Per CPRA: GPC is a legally binding "Do Not Sell or Share" signal
   * It does NOT mean "Do Not Track" - first-party analytics are still allowed
   */
  function checkGPC() {
    return (navigator.globalPrivacyControl === true) ||
           (navigator.doNotTrack === '1') ||
           (window.doNotTrack === '1');
  }

  // ==========================================================================
  // SHOPIFY CONSENT API
  // ==========================================================================

  function getConsentFromShopify() {
    try {
      if (!window.Shopify?.customerPrivacy?.currentVisitorConsent) {
        return null;
      }

      var consent = window.Shopify.customerPrivacy.currentVisitorConsent();

      // No consent collected yet
      if (!consent || (consent.analytics === '' && consent.marketing === '' && consent.preferences === '')) {
        return null;
      }

      var analytics = consent.analytics === 'yes';
      var marketing = consent.marketing === 'yes';
      var preferences = consent.preferences === 'yes';

      // Determine sale_of_data based on config
      // NOTE: Shopify's raw consent.sale_of_data is often '' (empty string)
      // This is expected for US visitors without explicit CCPA opt-out UI
      var saleOfData = CONFIG.saleOfDataFollowsMarketing
        ? marketing  // Map marketing → sale_of_data
        : (consent.sale_of_data !== 'no');  // Use Shopify's independent value

      return {
        analytics: analytics,
        marketing: marketing,
        preferences: preferences,
        sale_of_data: saleOfData,
        source: 'shopify_api',
        rawShopify: consent  // Keep raw values for debugging
      };
    } catch (e) {
      log('Error reading consent:', e);
      return null;
    }
  }

  // ==========================================================================
  // CONSENT UPDATES
  // ==========================================================================

  /**
   * Map Shopify consent to Google Consent Mode v2
   *
   * IMPORTANT: ad_user_data and ad_personalization follow sale_of_data (not marketing)
   * This is correct because they control cross-context data sharing (CPRA regulated)
   */
  function mapToGoogleConsent(consent, gpcActive) {
    if (!consent) return CONFIG.defaultConsent;

    // GPC overrides sale_of_data (legally required)
    // User can still grant analytics/marketing, but sale/sharing blocked
    var effectiveSaleOfData = gpcActive ? false : consent.sale_of_data;

    return {
      'analytics_storage': consent.analytics ? 'granted' : 'denied',
      'ad_storage': consent.marketing ? 'granted' : 'denied',
      'ad_user_data': effectiveSaleOfData ? 'granted' : 'denied',      // Follows sale_of_data
      'ad_personalization': effectiveSaleOfData ? 'granted' : 'denied', // Follows sale_of_data
      'personalization_storage': consent.preferences ? 'granted' : 'denied',
      'functionality_storage': 'granted',
      'security_storage': 'granted'
    };
  }

  function updateGoogleConsent(consent, gpcActive) {
    var consentState = mapToGoogleConsent(consent, gpcActive);
    var effectiveSaleOfData = gpcActive ? false : consent.sale_of_data;

    gtag('consent', 'update', consentState);

    window.dataLayer.push({
      event: 'consent_updated',
      consent_state: consentState,
      analytics_consent: consent.analytics,
      marketing_consent: consent.marketing,
      preferences_consent: consent.preferences,
      sale_of_data_consent: effectiveSaleOfData,
      sale_of_data_banner: consent.sale_of_data,  // What banner/config says
      sale_of_data_effective: effectiveSaleOfData, // After GPC override
      gpc_detected: gpcActive,
      gpc_override_applied: gpcActive && consent.sale_of_data, // GPC blocked granted consent
      consent_source: consent.source
    });

    log('Google consent updated:',
        'analytics=' + consentState.analytics_storage,
        'ads=' + consentState.ad_storage,
        'ad_user_data=' + consentState.ad_user_data,
        gpcActive ? '(GPC ACTIVE)' : '');
  }

  function updateMicrosoftConsent(consent) {
    window.microsoftConsentState = {
      analytics: consent ? consent.analytics : false,
      advertising: consent ? consent.marketing : false
    };

    window.dataLayer.push({
      event: 'microsoft_consent_updated',
      microsoft_analytics_consent: window.microsoftConsentState.analytics,
      microsoft_advertising_consent: window.microsoftConsentState.advertising
    });
  }

  function saveToSessionStorage(consent, gpcActive) {
    try {
      var effectiveSaleOfData = gpcActive ? false : consent.sale_of_data;
      sessionStorage.setItem('jy_consent_state', JSON.stringify({
        analytics: consent.analytics || false,
        marketing: consent.marketing || false,
        preferences: consent.preferences || false,
        sale_of_data: effectiveSaleOfData,
        gpc_active: gpcActive,
        timestamp: Date.now(),
        source: consent.source || 'unknown'
      }));
    } catch (e) {}
  }

  function updateAllConsent(consent) {
    if (!consent) return;

    // CRITICAL: Check GPC on EVERY consent update
    // GPC is an immutable override, not a one-time check
    var gpcActive = checkGPC();

    if (gpcActive) {
      log('GPC active - sale_of_data forced to denied');
    }

    updateGoogleConsent(consent, gpcActive);
    updateMicrosoftConsent(consent);
    saveToSessionStorage(consent, gpcActive);
    consentInitialized = true;
  }

  // ==========================================================================
  // EVENT MONITORING
  // ==========================================================================

  function handleConsentChange() {
    var consent = getConsentFromShopify();
    if (!consent) return;

    var stateSignature = [consent.analytics, consent.marketing, consent.preferences, consent.sale_of_data].join('|');

    if (stateSignature !== lastConsentState) {
      log('Consent changed:', stateSignature);
      log('  Analytics:', consent.analytics);
      log('  Marketing:', consent.marketing);
      log('  Preferences:', consent.preferences);
      log('  Sale of data:', consent.sale_of_data, CONFIG.saleOfDataFollowsMarketing ? '(follows marketing)' : '(independent)');

      lastConsentState = stateSignature;
      updateAllConsent(consent);
    }
  }

  // ==========================================================================
  // INITIALIZATION
  // ==========================================================================

  function waitForShopifyAPI(callback) {
    var startTime = Date.now();
    var maxWait = 10000;

    var interval = setInterval(function() {
      if (window.Shopify?.customerPrivacy?.currentVisitorConsent) {
        clearInterval(interval);
        log('Shopify API ready after', (Date.now() - startTime) + 'ms');
        callback(true);
      } else if (Date.now() - startTime > maxWait) {
        clearInterval(interval);
        log('Shopify API timeout');
        callback(false);
      }
    }, 100);
  }

  function init() {
    log('Initializing...');

    // Log GPC status (but don't exit early)
    var gpcDetected = checkGPC();
    if (gpcDetected) {
      log('GPC/DNT detected - will enforce on all consent updates');
      log('Note: GPC blocks sale/sharing only. Analytics can still be granted.');
      window.dataLayer.push({
        event: 'consent_gpc_detected',
        gpc_signal: true,
        gpc_effect: 'sale_of_data_blocked'
      });
    }

    waitForShopifyAPI(function(ready) {
      if (!ready) {
        log('Using default consent (API unavailable)');
        window.microsoftConsentState = { analytics: false, advertising: false };
        return;
      }

      // Small delay for consent values to populate
      setTimeout(function() {
        var consent = getConsentFromShopify();

        if (consent) {
          log('Found stored consent');
          lastConsentState = [consent.analytics, consent.marketing, consent.preferences, consent.sale_of_data].join('|');
          consent.source = 'stored';

          // Use updateAllConsent which checks GPC on every call
          updateAllConsent(consent);

          log('Loaded consent - GPC will override if active');
        } else {
          log('No consent yet - using defaults');
          window.microsoftConsentState = { analytics: false, advertising: false };
        }

        // Event listener
        document.addEventListener(CONFIG.consentEvent, function() {
          log('Consent event fired');
          handleConsentChange();
        });

        // Optional polling
        if (CONFIG.pollingInterval > 0) {
          setInterval(handleConsentChange, CONFIG.pollingInterval);
        }

        log('Ready');
      }, 200);
    });

    // Debug API
    if (CONFIG.debug) {
      window.consentDebug = {
        getRawShopify: function() {
          return window.Shopify?.customerPrivacy?.currentVisitorConsent();
        },
        getParsedConsent: function() {
          return getConsentFromShopify();
        },
        getState: function() {
          var gpc = checkGPC();
          var consent = getConsentFromShopify();
          return {
            consent: consent,
            gpc_active: gpc,
            effective_sale_of_data: gpc ? false : (consent ? consent.sale_of_data : false),
            initialized: consentInitialized,
            config: {
              saleOfDataFollowsMarketing: CONFIG.saleOfDataFollowsMarketing
            }
          };
        },
        checkGPC: checkGPC,
        refresh: handleConsentChange,
        testShopifyMethods: function() {
          log('=== Shopify API Test ===');
          log('currentVisitorConsent():', window.Shopify?.customerPrivacy?.currentVisitorConsent());
          log('saleOfDataAllowed():', window.Shopify?.customerPrivacy?.saleOfDataAllowed());
          log('marketingAllowed():', window.Shopify?.customerPrivacy?.marketingAllowed());
          log('analyticsProcessingAllowed():', window.Shopify?.customerPrivacy?.analyticsProcessingAllowed());
        }
      };
    }

    // Public API
    window.shopifyConsentMode = {
      version: CONFIG.version,
      getState: function() {
        var gpc = checkGPC();
        var consent = getConsentFromShopify();
        return {
          consent: consent,
          microsoft: window.microsoftConsentState,
          gpc_active: gpc,
          effective_sale_of_data: gpc ? false : (consent ? consent.sale_of_data : false),
          initialized: consentInitialized
        };
      },
      isGPCActive: checkGPC
    };
  }

  // Run
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', init);
  } else {
    init();
  }

})();
</script>
