{% comment %}
/**
 * JY Insights - Shopify Privacy API + Consent Mode Integration
 * Version: 2.1 (Optimized & Configurable)
 * Last Updated: 2026-01-12
 *
 * WHAT'S NEW IN v2.1:
 * - Removed unnecessary event listeners (down to 1 official event)
 * - Configurable polling interval (default: 2 seconds, was 500ms)
 * - Quiet logging - only logs when consent actually changes
 * - Config toggle: sale_of_data can follow marketing or use Shopify logic
 * - Much more efficient and less noisy
 *
 * KEY FEATURES:
 * - Uses modern Shopify.customerPrivacy.currentVisitorConsent() API
 * - No token decoding - direct API access
 * - Event-driven with optional backup polling
 * - Configurable sale_of_data behavior
 *
 * REQUIREMENTS:
 * 1. Add loadFeatures script BEFORE this in theme.liquid:
 *    <script>
 *      if (window.Shopify && window.Shopify.loadFeatures) {
 *        window.Shopify.loadFeatures([{
 *          name: 'consent-tracking-api',
 *          version: '0.1'
 *        }]);
 *      }
 *    </script>
 *
 * 2. Then add this snippet:
 *    {% render 'shopify-privacy-consent-mode-v2.0-modern-api' %}
 *    {% render 'gold-storefront-datalayer-GA4-enhanced' %}
 *
 * CONFIGURATION:
 * - saleOfDataFollowsMarketing: true/false - tie sale_of_data to marketing
 * - pollingInterval: milliseconds (0 to disable polling)
 * - debug: true/false - enable console logging
 */
{% endcomment %}

<script type="text/javascript">
(function() {
  'use strict';

  // ==========================================================================
  // CONFIGURATION
  // ==========================================================================

  var CONFIG = {
    debug: true,
    version: '2.1',

    // Sale of Data Behavior
    // Set to true: sale_of_data follows marketing consent (both granted/denied together)
    // Set to false: sale_of_data uses Shopify's independent logic (CCPA opt-out based)
    saleOfDataFollowsMarketing: true,

    // Primary Shopify consent event (only one documented)
    consentEvent: 'visitorConsentCollected',

    // Polling interval (ms) - backup mechanism to catch changes
    // Set to 0 to disable polling (event-only mode)
    pollingInterval: 2000,  // Check every 2 seconds instead of 500ms

    defaultConsent: {
      analytics_storage: 'denied',
      ad_storage: 'denied',
      ad_user_data: 'denied',
      ad_personalization: 'denied',
      personalization_storage: 'denied',
      functionality_storage: 'granted',
      security_storage: 'granted'
    }
  };

  var lastConsentState = null;
  var consentInitialized = false;

  // ==========================================================================
  // IMMEDIATE CONSENT INITIALIZATION (for GTM)
  // ==========================================================================

  // GTM needs consent set BEFORE it loads, so we set defaults immediately
  // This will be updated later when Shopify API provides stored consent
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}

  // Set GTM consent defaults (for GTM's Consent tab)
  gtag('consent', 'default', Object.assign({}, CONFIG.defaultConsent, {
    wait_for_update: 500
  }));

  // Also push consent_default event to dataLayer (for GTM's Data Layer tab)
  window.dataLayer.push({
    event: 'consent_default',
    consent_state: CONFIG.defaultConsent,
    analytics_consent: false,
    marketing_consent: false,
    preferences_consent: false,
    sale_of_data_consent: false,
    consent_source: 'default'
  });

  // Save default consent to sessionStorage for checkout pixel (will be updated when user grants consent)
  try {
    // Only set defaults if no consent is already stored (don't overwrite returning user's consent)
    if (!sessionStorage.getItem('jy_consent_state')) {
      sessionStorage.setItem('jy_consent_state', JSON.stringify({
        analytics: false,
        marketing: false,
        preferences: false,
        sale_of_data: false,
        timestamp: Date.now(),
        source: 'default'
      }));
    }
  } catch (e) {
    // sessionStorage not available
  }

  // ==========================================================================
  // LOGGING
  // ==========================================================================

  function log() {
    if (CONFIG.debug && typeof console !== 'undefined') {
      console.log('[Shopify Consent v2.0]', Array.prototype.slice.call(arguments).join(' '));
    }
  }

  // ==========================================================================
  // GOOGLE CONSENT MODE v2
  // ==========================================================================

  function initializeGoogleConsentDefaults() {
    log('üöÄ Initializing Google Consent Mode v2 for new user');

    // Note: consent_default event and gtag('consent', 'default') already called at line 90-103
    // This function is only called for NEW users (no stored consent)
    // Nothing to do here - defaults already set at top level

    log('‚úÖ Consent defaults already initialized (using denied defaults from line 90)');
  }

  function initializeMicrosoftConsent() {
    window.microsoftConsentState = {
      analytics: false,
      advertising: false
    };
    log('‚úÖ Microsoft consent initialized');
  }

  // ==========================================================================
  // SHOPIFY CONSENT API
  // ==========================================================================

  function getConsentFromShopify() {
    try {
      if (!window.Shopify || !window.Shopify.customerPrivacy) {
        log('‚ö†Ô∏è Shopify.customerPrivacy not available');
        return null;
      }

      if (typeof window.Shopify.customerPrivacy.currentVisitorConsent !== 'function') {
        log('‚ö†Ô∏è currentVisitorConsent() method not available');
        return null;
      }

      var consent = window.Shopify.customerPrivacy.currentVisitorConsent();

      // Check if we have actual consent values (not empty strings)
      if (!consent || (consent.analytics === '' && consent.marketing === '' && consent.preferences === '')) {
        log('‚ö†Ô∏è No consent collected yet');
        return null;
      }

      var analyticsGranted = consent.analytics === 'yes';
      var marketingGranted = consent.marketing === 'yes';
      var preferencesGranted = consent.preferences === 'yes';

      // Determine sale_of_data based on config
      var saleOfDataGranted;
      if (CONFIG.saleOfDataFollowsMarketing) {
        // Mirror marketing consent
        saleOfDataGranted = marketingGranted;
      } else {
        // Use Shopify's independent logic (CCPA opt-out based)
        saleOfDataGranted = consent.sale_of_data !== 'no';
      }

      return {
        analytics: analyticsGranted,
        marketing: marketingGranted,
        preferences: preferencesGranted,
        sale_of_data: saleOfDataGranted,
        source: 'shopify_api',
        rawConsent: consent
      };

    } catch (e) {
      log('‚ùå Error getting consent:', e);
      return null;
    }
  }

  // ==========================================================================
  // CONSENT UPDATES
  // ==========================================================================

  function mapShopifyToGoogleConsent(consent) {
    if (!consent) {
      return CONFIG.defaultConsent;
    }

    return {
      'analytics_storage': consent.analytics ? 'granted' : 'denied',
      'ad_storage': consent.marketing ? 'granted' : 'denied',
      'ad_user_data': consent.marketing ? 'granted' : 'denied',
      'ad_personalization': consent.marketing ? 'granted' : 'denied',
      'personalization_storage': consent.preferences ? 'granted' : 'denied',
      'functionality_storage': 'granted',
      'security_storage': 'granted'
    };
  }

  function updateGoogleConsent(consent) {
    var consentState = mapShopifyToGoogleConsent(consent);

    log('üîÑ Updating Google Consent:',
        'analytics=' + consentState.analytics_storage,
        'ads=' + consentState.ad_storage);

    // Call gtag directly (defined at line 87)
    gtag('consent', 'update', consentState);
    log('‚úÖ gtag("consent", "update") called');

    if (typeof window.dataLayer !== 'undefined') {
      window.dataLayer.push({
        event: 'consent_updated',
        consent_state: consentState,
        analytics_consent: consent ? consent.analytics : false,
        marketing_consent: consent ? consent.marketing : false,
        preferences_consent: consent ? consent.preferences : false,
        sale_of_data_consent: consent ? consent.sale_of_data : false,
        consent_source: consent ? consent.source : 'default'
      });
      log('‚úÖ consent_updated event pushed to dataLayer');
    } else {
      log('‚ö†Ô∏è dataLayer not available');
    }
  }

  function updateMicrosoftConsent(consent) {
    var analyticsGranted = consent ? consent.analytics : false;
    var marketingGranted = consent ? consent.marketing : false;

    window.microsoftConsentState = {
      analytics: analyticsGranted,
      advertising: marketingGranted
    };

    if (typeof window.dataLayer !== 'undefined') {
      window.dataLayer.push({
        event: 'microsoft_consent_updated',
        microsoft_analytics_consent: analyticsGranted,
        microsoft_advertising_consent: marketingGranted
      });
    }

    log('‚úÖ Microsoft consent updated');
  }

  function updateAllConsentModes(consent) {
    if (!consent) {
      log('‚ö†Ô∏è No consent to update');
      return;
    }

    log('üîÑ Updating all consent modes');
    updateGoogleConsent(consent);
    updateMicrosoftConsent(consent);
    consentInitialized = true;

    // Save consent to sessionStorage for checkout pixel
    // Checkout runs in sandboxed iframe and can't access Shopify's customerPrivacy API
    saveConsentToSessionStorage(consent);
  }

  /**
   * Save consent state to sessionStorage for checkout pixel
   * The checkout pixel runs in a sandboxed iframe without access to Shopify's
   * customerPrivacy API, so we pass consent state via sessionStorage
   */
  function saveConsentToSessionStorage(consent) {
    try {
      var consentData = {
        analytics: consent.analytics || false,
        marketing: consent.marketing || false,
        preferences: consent.preferences || false,
        sale_of_data: consent.sale_of_data || false,
        timestamp: Date.now(),
        source: consent.source || 'unknown'
      };
      sessionStorage.setItem('jy_consent_state', JSON.stringify(consentData));
      log('‚úÖ Consent saved to sessionStorage for checkout pixel');
    } catch (e) {
      log('‚ö†Ô∏è Could not save consent to sessionStorage:', e);
    }
  }

  // ==========================================================================
  // EVENT-DRIVEN MONITORING
  // ==========================================================================

  function handleConsentChange() {
    var consent = getConsentFromShopify();

    if (!consent) {
      return;
    }

    // Create state signature to detect changes
    var currentState = consent.analytics + '|' + consent.marketing + '|' + consent.preferences + '|' + consent.sale_of_data;

    if (currentState !== lastConsentState) {
      log('üîî Consent changed:', lastConsentState || 'initial', '->', currentState);
      log('üìä Values:',
          'analytics=' + consent.analytics,
          'marketing=' + consent.marketing,
          'preferences=' + consent.preferences,
          'sale_of_data=' + consent.sale_of_data,
          (CONFIG.saleOfDataFollowsMarketing ? '(following marketing)' : '(independent)'));
      lastConsentState = currentState;
      updateAllConsentModes(consent);
    }
  }

  function setupEventListeners() {
    log('üëÇ Setting up event listener for:', CONFIG.consentEvent);

    // Listen for the official Shopify consent event
    document.addEventListener(CONFIG.consentEvent, function(e) {
      log('üîî Event fired:', CONFIG.consentEvent);
      handleConsentChange();
    });

    log('‚úÖ Event listener active');
  }

  // ==========================================================================
  // GPC DETECTION
  // ==========================================================================

  function checkGlobalPrivacyControl() {
    if (typeof navigator.globalPrivacyControl !== 'undefined' && navigator.globalPrivacyControl === true) {
      log('üö´ GPC Signal Detected');
      return true;
    }

    if (navigator.doNotTrack === '1' || window.doNotTrack === '1') {
      log('üö´ DNT Signal Detected');
      return true;
    }

    return false;
  }

  function handleGPCSignal() {
    var hasGPCSignal = checkGlobalPrivacyControl();
    if (hasGPCSignal) {
      log('Auto-denying consent per GPC/DNT');
      updateAllConsentModes({
        analytics: false,
        marketing: false,
        preferences: false,
        sale_of_data: false,
        source: 'gpc'
      });

      if (typeof window.dataLayer !== 'undefined') {
        window.dataLayer.push({
          event: 'consent_gpc_detected',
          gpc_signal: true,
          consent_auto_denied: true
        });
      }

      return true;
    }
    return false;
  }

  // ==========================================================================
  // INITIALIZATION
  // ==========================================================================

  function waitForShopifyAPI(callback, maxWait) {
    var startTime = Date.now();
    var maxWaitTime = maxWait || 10000;

    log('‚è≥ Waiting for Shopify Customer Privacy API...');

    var checkInterval = setInterval(function() {
      var hasShopify = typeof window.Shopify !== 'undefined';
      var hasPrivacy = hasShopify && typeof window.Shopify.customerPrivacy !== 'undefined';
      var hasMethod = hasPrivacy && typeof window.Shopify.customerPrivacy.currentVisitorConsent === 'function';

      if (hasMethod) {
        clearInterval(checkInterval);
        var elapsed = Date.now() - startTime;
        log('‚úÖ API ready after', elapsed + 'ms');
        callback(true);
      } else if (Date.now() - startTime > maxWaitTime) {
        clearInterval(checkInterval);
        log('‚è±Ô∏è Timeout after', maxWaitTime + 'ms');
        log('  - Has Shopify?', hasShopify);
        log('  - Has customerPrivacy?', hasPrivacy);
        log('  - Has currentVisitorConsent()?', hasMethod);
        callback(false);
      }
    }, 100);
  }

  function init() {
    log('üöÄ Initializing v' + CONFIG.version);

    // Check for GPC first
    if (handleGPCSignal()) {
      log('GPC/DNT detected - consent denied');
      // Still initialize consent modes with denied state
      initializeGoogleConsentDefaults();
      initializeMicrosoftConsent();
      return;
    }

    // Wait for Shopify API to be ready BEFORE setting consent defaults
    waitForShopifyAPI(function(ready) {
      if (!ready) {
        log('‚ö†Ô∏è Shopify Customer Privacy API not available');
        // Fallback: initialize with defaults
        initializeGoogleConsentDefaults();
        initializeMicrosoftConsent();
        return;
      }

      log('‚úÖ Shopify Customer Privacy API ready');

      // Wait a moment for consent values to be fully loaded
      // Sometimes API is ready but values aren't populated yet
      setTimeout(function() {
        // Get initial consent (from cookie for returning users)
        var initialConsent = getConsentFromShopify();

        if (initialConsent) {
          // RETURNING USER: Update consent to stored values
          log('‚úÖ Initial consent found (returning user or already granted)');

          // Set the initial state signature
          lastConsentState = initialConsent.analytics + '|' + initialConsent.marketing + '|' +
                            initialConsent.preferences + '|' + initialConsent.sale_of_data;

          // Initialize Microsoft consent
          initializeMicrosoftConsent();

          // Update consent to stored values (defaults already set to 'denied' at line 89)
          var storedConsentDefaults = mapShopifyToGoogleConsent(initialConsent);

          // Update gtag consent immediately using the gtag function defined at line 87
          // The gtag function pushes to dataLayer, which GTM will process
          log('üîÑ Updating consent to stored values...');

          // Call gtag to update consent state (this pushes to dataLayer)
          gtag('consent', 'update', storedConsentDefaults);
          log('‚úÖ gtag("consent", "update") called');

          // Also push consent_updated event to dataLayer
          window.dataLayer.push({
            event: 'consent_updated',
            consent_state: storedConsentDefaults,
            analytics_consent: initialConsent.analytics,
            marketing_consent: initialConsent.marketing,
            preferences_consent: initialConsent.preferences,
            sale_of_data_consent: initialConsent.sale_of_data,
            consent_source: 'stored'
          });
          log('‚úÖ consent_updated event pushed to dataLayer');

          // Update Microsoft consent too
          updateMicrosoftConsent(initialConsent);

          consentInitialized = true;

          log('üìä Loaded consent:',
              'analytics=' + initialConsent.analytics,
              'marketing=' + initialConsent.marketing,
              'preferences=' + initialConsent.preferences,
              'sale_of_data=' + initialConsent.sale_of_data);
        } else {
          // NEW USER: Initialize with denied defaults
          log('‚ö†Ô∏è No initial consent - setting denied defaults (GDPR-safe)');
          initializeGoogleConsentDefaults();
          initializeMicrosoftConsent();
        }

        // Set up event-driven monitoring
        setupEventListeners();

        // Optional polling as backup
        if (CONFIG.pollingInterval > 0) {
          log('üëÅÔ∏è Polling enabled (every ' + CONFIG.pollingInterval + 'ms)');
          setInterval(handleConsentChange, CONFIG.pollingInterval);
        } else {
          log('üì° Event-only mode (no polling)');
        }

        log('‚úÖ Monitoring active');
      }, 200); // Wait 200ms for consent values to populate
    });

    // Expose debug functions
    if (CONFIG.debug) {
      window.consentDebug = {
        getConsent: function() {
          return window.Shopify?.customerPrivacy?.currentVisitorConsent();
        },
        checkNow: handleConsentChange,
        currentState: function() {
          return {
            shopify: getConsentFromShopify(),
            initialized: consentInitialized,
            lastState: lastConsentState
          };
        },
        grant: function() {
          // Simulate granting all consent
          updateAllConsentModes({
            analytics: true,
            marketing: true,
            preferences: true,
            sale_of_data: true,
            source: 'manual'
          });
        },
        deny: function() {
          updateAllConsentModes({
            analytics: false,
            marketing: false,
            preferences: false,
            sale_of_data: false,
            source: 'manual'
          });
        },
        testAPI: function() {
          log('=== API Test ===');
          log('Config: saleOfDataFollowsMarketing =', CONFIG.saleOfDataFollowsMarketing);
          log('Shopify.customerPrivacy:', window.Shopify?.customerPrivacy);
          log('currentVisitorConsent():', window.Shopify?.customerPrivacy?.currentVisitorConsent());
          log('shouldShowBanner():', window.Shopify?.customerPrivacy?.shouldShowBanner());
          log('analyticsProcessingAllowed():', window.Shopify?.customerPrivacy?.analyticsProcessingAllowed());
          log('marketingAllowed():', window.Shopify?.customerPrivacy?.marketingAllowed());
          log('saleOfDataAllowed():', window.Shopify?.customerPrivacy?.saleOfDataAllowed());
        },
        setFollowMarketing: function(value) {
          CONFIG.saleOfDataFollowsMarketing = value;
          log('üîß saleOfDataFollowsMarketing set to:', value);
          handleConsentChange(); // Re-check consent with new setting
        }
      };
      log('üõ†Ô∏è Debug available at window.consentDebug');
    }

    // Public API
    window.shopifyConsentMode = {
      version: CONFIG.version,
      grantConsent: function() {
        updateAllConsentModes({
          analytics: true,
          marketing: true,
          preferences: true,
          sale_of_data: true,
          source: 'api'
        });
      },
      denyConsent: function() {
        updateAllConsentModes({
          analytics: false,
          marketing: false,
          preferences: false,
          sale_of_data: false,
          source: 'api'
        });
      },
      getConsentState: function() {
        return {
          shopify: getConsentFromShopify(),
          microsoft: window.microsoftConsentState,
          initialized: consentInitialized
        };
      }
    };

    log('‚úÖ Ready');
  }

  // Run initialization
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', init);
  } else {
    init();
  }

})();
</script>
