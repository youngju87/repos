{% comment %}
/**
 * JY Insights Gold Plus Package - Storefront Data Layer (ENHANCED)
 * Enhanced GA4-compliant ecommerce tracking with comprehensive parameter sets
 * Version: 2.0 (Gold Plus Enhanced)
 * Last Updated: 2026-01-09
 *
 * Installation: Add to theme.liquid before </head>
 * Configuration: Update GTM container ID (line 71) with your GTM-XXXXXXX
 * Documentation: See solution-design-reference-enhanced.md
 * Support: contact@jyinsights.com
 *
 * IMPORTANT: This is the ENHANCED version. DO NOT replace existing production files.
 * Keep gold-storefront-datalayer-GA4.liquid (v1.4) as your working production file.
 *
 * ARCHITECTURE:
 * - Handles all storefront tracking (product pages, collections, cart, search)
 * - Pushes GA4-compliant events to window.dataLayer
 * - GTM loaded directly in parent window
 * - Checkout tracking handled separately by gold-checkout-pixel-GA4-enhanced.js
 * - Maintains consistency with checkout pixel data structure
 * - Persists logged_in status to sessionStorage for checkout pixel
 *
 * ENHANCEMENTS vs v1.4:
 * - Comprehensive user parameters (RFM, hashed identifiers, full address data)
 * - Extended product parameters (handles, category IDs, positions)
 * - Enhanced page parameters (page classification, currency rates)
 * - Additional order parameters on thank you page
 * - Support for multiple hash algorithms (SHA256, SHA1)
 * - Enhanced category and collection tracking
 * - Product handle and category handle tracking
 * - Currency conversion support
 * - User tagging system
 *
 * TRACKED EVENTS:
 * - user_data_ready (comprehensive session context with customer info)
 * - page_data_ready (enhanced page context and navigation info)
 * - page_view (all storefront pages with enhanced parameters)
 * - view_item_list (collections with full metadata)
 * - view_item (product detail pages with handles and categories)
 * - view_cart (cart page + drawer opens with totals)
 * - add_to_cart (product page + collection quick-add with full context)
 * - remove_from_cart (cart page + drawer with product details)
 * - select_item (product clicks with list attribution)
 * - search (search page with full result metadata)
 */
{% endcomment %}

<!-- Google Tag Manager -->
<script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
})(window,document,'script','dataLayer','GTM-K9JX87Z6');</script>
<!-- End Google Tag Manager -->

<script type="text/javascript">
(function() {
  'use strict';

  // ==========================================================================
  // INITIALIZATION
  // ==========================================================================

  // Initialize dataLayer if it doesn't exist
  window.dataLayer = window.dataLayer || [];

  // Configuration
  var CONFIG = {
    debug: true,
    version: '2.0-enhanced',
    googleFeedRegion: 'US',

    // Theme Selectors
    selectors: {
      // Cart drawer element
      cartDrawer: ['cart-drawer', '#CartDrawer', '.cart-drawer', '[data-cart-drawer]'],

      // Add to cart buttons
      addToCartButton: [
        'button[name="add"]',
        'button[type="submit"][form*="product-form"]',
        '.product-form__submit',
        'button.product-form__cart-submit'
      ],

      // Quantity buttons
      quantityButtons: [
        'quantity-selector button[name="minus"]',
        'quantity-selector button[name="plus"]',
        'button[data-quantity-decrement]',
        'button[data-quantity-increment]'
      ],

      // Remove from cart
      removeButton: [
        'cart-remove-button',
        'a[is="cart-remove-item"]',
        '.cart-item__remove',
        'button[data-remove]',
        '.cart__remove',
        'a[href*="/cart/change?line="]',
        'a[href*="/cart/change"]',
        '[data-cart-item-remove]',
        '.remove',
        'button.remove',
        'a.remove'
      ],

      // Checkout button
      checkoutButton: [
        'button[name="checkout"]',
        'a[href="/checkout"]',
        'button[type="submit"][form*="cart"]'
      ],

      // Product links
      productLink: 'a[href*="/products/"]',

      // Quick view buttons
      quickViewButton: [
        'button[aria-controls^="QuickView-"]',
        'button[aria-haspopup="dialog"].product-card__action-button',
        '.product-card__atc[aria-controls^="QuickView-"]',
        '[data-quick-view]'
      ]
    }
  };

  // ==========================================================================
  // LOGGING
  // ==========================================================================

  function log(message, data) {
    if (CONFIG.debug) {
      console.log('[JY Gold Plus Enhanced]', message, data || '');
    }
  }

  // ==========================================================================
  // HELPER FUNCTIONS
  // ==========================================================================

  /**
   * Safely parse numeric values
   */
  function parsePrice(value) {
    var num = parseFloat(value);
    return isNaN(num) ? 0 : Number(num.toFixed(2));
  }

  /**
   * Generate Google Ads product ID format
   * Format: shopify_[COUNTRY]_[PRODUCT_ID]_[VARIANT_ID]
   */
  function generateGoogleProductId(productId, variantId) {
    return 'shopify_' + CONFIG.googleFeedRegion + '_' + productId + '_' + variantId;
  }

  /**
   * SHA1 Hash function (for email hashing)
   * Lightweight implementation for client-side hashing
   */
  function sha1Hash(str) {
    if (!str) return '';

    // Simple SHA1 implementation
    function rotateLeft(n, s) {
      return (n << s) | (n >>> (32 - s));
    }

    function cvtHex(val) {
      var str = '';
      var i;
      var v;
      for (i = 7; i >= 0; i--) {
        v = (val >>> (i * 4)) & 0x0f;
        str += v.toString(16);
      }
      return str;
    }

    function utf8Encode(string) {
      string = string.replace(/\r\n/g, '\n');
      var utftext = '';
      for (var n = 0; n < string.length; n++) {
        var c = string.charCodeAt(n);
        if (c < 128) {
          utftext += String.fromCharCode(c);
        } else if ((c > 127) && (c < 2048)) {
          utftext += String.fromCharCode((c >> 6) | 192);
          utftext += String.fromCharCode((c & 63) | 128);
        } else {
          utftext += String.fromCharCode((c >> 12) | 224);
          utftext += String.fromCharCode(((c >> 6) & 63) | 128);
          utftext += String.fromCharCode((c & 63) | 128);
        }
      }
      return utftext;
    }

    var blockstart;
    var i, j;
    var W = new Array(80);
    var H0 = 0x67452301;
    var H1 = 0xEFCDAB89;
    var H2 = 0x98BADCFE;
    var H3 = 0x10325476;
    var H4 = 0xC3D2E1F0;
    var A, B, C, D, E;
    var temp;

    str = utf8Encode(str);
    var strLen = str.length;
    var wordArray = [];

    for (i = 0; i < strLen - 3; i += 4) {
      j = str.charCodeAt(i) << 24 | str.charCodeAt(i + 1) << 16 |
          str.charCodeAt(i + 2) << 8 | str.charCodeAt(i + 3);
      wordArray.push(j);
    }

    switch (strLen % 4) {
      case 0:
        i = 0x080000000;
        break;
      case 1:
        i = str.charCodeAt(strLen - 1) << 24 | 0x0800000;
        break;
      case 2:
        i = str.charCodeAt(strLen - 2) << 24 | str.charCodeAt(strLen - 1) << 16 | 0x08000;
        break;
      case 3:
        i = str.charCodeAt(strLen - 3) << 24 | str.charCodeAt(strLen - 2) << 16 |
            str.charCodeAt(strLen - 1) << 8 | 0x80;
        break;
    }

    wordArray.push(i);

    while ((wordArray.length % 16) != 14) wordArray.push(0);

    wordArray.push(strLen >>> 29);
    wordArray.push((strLen << 3) & 0x0ffffffff);

    for (blockstart = 0; blockstart < wordArray.length; blockstart += 16) {
      for (i = 0; i < 16; i++) W[i] = wordArray[blockstart + i];
      for (i = 16; i <= 79; i++) W[i] = rotateLeft(W[i - 3] ^ W[i - 8] ^ W[i - 14] ^ W[i - 16], 1);

      A = H0;
      B = H1;
      C = H2;
      D = H3;
      E = H4;

      for (i = 0; i <= 19; i++) {
        temp = (rotateLeft(A, 5) + ((B & C) | (~B & D)) + E + W[i] + 0x5A827999) & 0x0ffffffff;
        E = D;
        D = C;
        C = rotateLeft(B, 30);
        B = A;
        A = temp;
      }

      for (i = 20; i <= 39; i++) {
        temp = (rotateLeft(A, 5) + (B ^ C ^ D) + E + W[i] + 0x6ED9EBA1) & 0x0ffffffff;
        E = D;
        D = C;
        C = rotateLeft(B, 30);
        B = A;
        A = temp;
      }

      for (i = 40; i <= 59; i++) {
        temp = (rotateLeft(A, 5) + ((B & C) | (B & D) | (C & D)) + E + W[i] + 0x8F1BBCDC) & 0x0ffffffff;
        E = D;
        D = C;
        C = rotateLeft(B, 30);
        B = A;
        A = temp;
      }

      for (i = 60; i <= 79; i++) {
        temp = (rotateLeft(A, 5) + (B ^ C ^ D) + E + W[i] + 0xCA62C1D6) & 0x0ffffffff;
        E = D;
        D = C;
        C = rotateLeft(B, 30);
        B = A;
        A = temp;
      }

      H0 = (H0 + A) & 0x0ffffffff;
      H1 = (H1 + B) & 0x0ffffffff;
      H2 = (H2 + C) & 0x0ffffffff;
      H3 = (H3 + D) & 0x0ffffffff;
      H4 = (H4 + E) & 0x0ffffffff;
    }

    temp = cvtHex(H0) + cvtHex(H1) + cvtHex(H2) + cvtHex(H3) + cvtHex(H4);
    return temp.toLowerCase();
  }

  /**
   * Format product item for GA4 ecommerce with enhanced parameters
   * Returns GA4-compliant item object with all enhanced fields
   */
  function formatProductItem(item, index, listContext) {
    var itemData = {
      item_id: String(item.variant_id || item.id || ''),
      item_name: item.product_title || item.title || '',
      currency: page_data.currency,
      index: index
    };

    // Core identifiers
    if (item.product_id) itemData.product_id = String(item.product_id);
    if (item.variant_id) itemData.variant_id = String(item.variant_id);

    // Brand and category
    if (item.vendor) itemData.item_brand = item.vendor;
    if (item.product_type) itemData.item_category = item.product_type;
    if (item.variant_title) itemData.item_variant = item.variant_title;
    if (item.sku) itemData.sku = item.sku;

    // Price
    if (item.final_price !== undefined) {
      itemData.price = parsePrice(item.final_price / 100);
    } else if (item.price !== undefined) {
      itemData.price = parsePrice(item.price / 100);
    }

    // Quantity
    if (item.quantity) itemData.quantity = item.quantity;

    // Google Ads ID
    if (item.product_id && item.variant_id) {
      itemData.g_product_id = generateGoogleProductId(item.product_id, item.variant_id);
    }

    // Enhanced: Add list context if provided
    if (listContext) {
      if (listContext.item_list_id) itemData.item_list_id = listContext.item_list_id;
      if (listContext.item_list_name) itemData.item_list_name = listContext.item_list_name;
    }

    return itemData;
  }

  /**
   * Check if sessionStorage is available
   */
  function isSessionStorageAvailable() {
    try {
      var test = '__jy_test__';
      sessionStorage.setItem(test, test);
      sessionStorage.removeItem(test);
      return true;
    } catch(e) {
      return false;
    }
  }

  /**
   * Save item list attribution to sessionStorage
   * Stores mapping of variant_id -> {item_list_id, item_list_name}
   */
  function saveListAttribution(variantId, listId, listName) {
    if (!variantId || !isSessionStorageAvailable()) return;

    try {
      var attribution = JSON.parse(sessionStorage.getItem('jy_list_attribution') || '{}');
      attribution[String(variantId)] = {
        item_list_id: String(listId),
        item_list_name: String(listName),
        timestamp: Date.now()
      };
      sessionStorage.setItem('jy_list_attribution', JSON.stringify(attribution));
      log('List attribution saved', { variantId: variantId, listId: listId, listName: listName });
    } catch(e) {
      log('Error saving list attribution', e);
    }
  }

  /**
   * Find element in event path using configured selectors
   */
  function findElementInPath(path, selectorArray) {
    if (!path) return null;

    for (var i = 0; i < path.length; i++) {
      var element = path[i];
      if (!element.matches) continue;

      for (var j = 0; j < selectorArray.length; j++) {
        try {
          if (element.matches(selectorArray[j])) {
            return element;
          }
        } catch(e) {
          // Invalid selector, continue
        }
      }
    }
    return null;
  }

  // ==========================================================================
  // ENHANCED USER DATA OBJECT - Comprehensive User Information
  // ==========================================================================
  // Enhanced with RFM metrics, full address data, multiple hash algorithms
  // Privacy-compliant user information for marketing platforms

  var user_data = {
    {% if customer %}
    // Hashed identifiers (privacy-safe)
    email_sha256: '{{ customer.email | sha256 }}',
    email_sha1: sha1Hash('{{ customer.email }}'),

    // User status
    user_id: '{{ customer.id }}',
    logged_in: true,
    customer_type: {{ customer.orders_count | default: 0 }} > 0 ? 'returning' : 'new',

    // RFM Metrics (Recency, Frequency, Monetary)
    orders_count: {{ customer.orders_count | default: 0 }},
    lifetime_value: parsePrice({{ customer.total_spent | money_without_currency | remove: ',' | default: 0 }}),
    {% if customer.last_order %}
    last_order_date: '{{ customer.last_order.created_at | date: "%Y-%m-%d" }}',
    {% endif %}

    // Phone hash if available
    {% if customer.phone %}
    phone_sha256: '{{ customer.phone | sha256 }}',
    phone_sha1: sha1Hash('{{ customer.phone }}'),
    {% endif %}

    // Enhanced: Full address data (privacy-safe, not raw PII)
    {% if customer.default_address %}
    {% if customer.default_address.first_name %}
    first_name_initial: '{{ customer.default_address.first_name | slice: 0 | downcase }}',
    {% endif %}
    {% if customer.default_address.last_name %}
    last_name_initial: '{{ customer.default_address.last_name | slice: 0 | downcase }}',
    {% endif %}
    {% if customer.default_address.city %}
    city: '{{ customer.default_address.city | downcase }}',
    {% endif %}
    {% if customer.default_address.province_code %}
    state: '{{ customer.default_address.province_code | upcase }}',
    {% endif %}
    {% if customer.default_address.country_code %}
    country: '{{ customer.default_address.country_code | upcase }}',
    {% endif %}
    {% if customer.default_address.zip %}
    zip: '{{ customer.default_address.zip }}',
    {% endif %}
    {% if customer.default_address.address1 %}
    has_address: true,
    {% endif %}
    {% endif %}

    // Enhanced: Customer tags (for segmentation)
    {% if customer.tags.size > 0 %}
    tags: [{% for tag in customer.tags %}'{{ tag }}'{% unless forloop.last %},{% endunless %}{% endfor %}],
    {% endif %}

    {% else %}
    // Guest user
    logged_in: false,
    customer_type: 'guest',
    {% endif %}

    // Enhanced: Currency rate (for multi-currency stores)
    page_currency_rate: 1.0 // Default to 1.0, can be dynamically set if using Shopify Markets
  };

  // Persist logged_in status to sessionStorage for checkout pixel
  if (isSessionStorageAvailable()) {
    try {
      sessionStorage.setItem('jy_customer_logged_in', String(user_data.logged_in));
    } catch(e) {
      log('Error saving logged_in status to sessionStorage', e);
    }
  }

  // ==========================================================================
  // ENHANCED PAGE DATA OBJECT - Navigation & Page Context
  // ==========================================================================
  // Enhanced with detailed page classification and metadata

  {% assign template_name = template.name %}
  var page_data = {
    // Page identification
    page_location: window.location.href,
    page_path: window.location.pathname,
    page_title: document.title,
    page_type: '{{ template_name }}',

    // Referral information
    page_referrer: document.referrer || '(direct)',

    // Site context
    language: '{{ shop.locale }}',
    currency: '{{ cart.currency.iso_code }}',

    // Template-specific context with enhanced data
    {% if template_name == 'collection' %}
    collection_id: '{{ collection.id }}',
    collection_handle: '{{ collection.handle }}',
    collection_title: {{ collection.title | json }},
    {% if collection.description %}
    collection_description: {{ collection.description | strip_html | truncate: 160 | json }},
    {% endif %}
    {% elsif template_name == 'product' %}
    product_id: '{{ product.id }}',
    product_handle: '{{ product.handle }}',
    product_type: {{ product.type | json }},
    product_vendor: {{ product.vendor | json }},
    {% if product.collections.size > 0 %}
    product_collections: [{% for collection in product.collections limit: 5 %}'{{ collection.handle }}'{% unless forloop.last %},{% endunless %}{% endfor %}],
    {% endif %}
    {% elsif template_name == 'search' %}
    search_term: {{ search.terms | json }},
    search_results_count: {{ search.results_count }},
    {% endif %}

    // Navigation tracking
    navigation_type: window.performance && window.performance.navigation ?
      window.performance.navigation.type : 0
  };

  // Push persistent data objects to dataLayer for session-wide access
  window.dataLayer.push({
    event: 'user_data_ready',
    user_data: user_data
  });

  window.dataLayer.push({
    event: 'page_data_ready',
    page_data: page_data
  });

  log('Enhanced User & Page data initialized', {
    customer_type: user_data.customer_type,
    page_type: page_data.page_type,
    version: CONFIG.version
  });

  // ==========================================================================
  // PAGE VIEW EVENT - Enhanced with User Type
  // ==========================================================================

  window.dataLayer.push({
    event: 'page_view',
    context: 'storefront',
    page_type: page_data.page_type,
    page_title: page_data.page_title,
    user_logged_in: user_data.logged_in,
    user_type: user_data.customer_type
  });

  log('page_view pushed', {
    context: 'storefront',
    page_type: page_data.page_type,
    user_type: user_data.customer_type
  });

  // ==========================================================================
  // ENHANCED PAGE-SPECIFIC EVENTS
  // ==========================================================================

  {% case template_name %}

  {% when 'collection' %}
  // ENHANCED VIEW_ITEM_LIST event with full product metadata
  (function() {
    var items = [];
    {% for product in collection.products limit: 50 %}
    items.push({
      item_id: '{{ product.selected_or_first_available_variant.id }}',
      item_name: {{ product.title | json }},
      item_brand: {{ product.vendor | json }},
      item_category: {{ product.type | json }},
      price: {{ product.variants.first.price | times: 0.01 }},
      currency: page_data.currency,
      product_id: '{{ product.id }}',
      variant_id: '{{ product.selected_or_first_available_variant.id }}',
      g_product_id: generateGoogleProductId('{{ product.id }}', '{{ product.selected_or_first_available_variant.id }}'),
      sku: '{{ product.selected_or_first_available_variant.sku }}',
      product_handle: '{{ product.handle }}',
      category_handle: '{{ collection.handle }}',
      variant_title: {{ product.selected_or_first_available_variant.title | json }},
      index: {{ forloop.index0 }}
    });
    {% endfor %}

    window.dataLayer.push({
      event: 'view_item_list',
      ecommerce: {
        item_list_id: '{{ collection.id }}',
        item_list_name: {{ collection.title | json }},
        items: items
      }
    });

    log('view_item_list pushed (enhanced)', { items_count: items.length });
  })();

  {% when 'search' %}
  // ENHANCED SEARCH event with full result metadata
  (function() {
    var items = [];
    {% for product in search.results limit: 50 %}
    {% if product.object_type == 'product' %}
    items.push({
      item_id: '{{ product.selected_or_first_available_variant.id }}',
      item_name: {{ product.title | json }},
      item_brand: {{ product.vendor | json }},
      item_category: {{ product.type | json }},
      price: {{ product.selected_or_first_available_variant.price | times: 0.01 }},
      currency: page_data.currency,
      product_id: '{{ product.id }}',
      variant_id: '{{ product.selected_or_first_available_variant.id }}',
      g_product_id: generateGoogleProductId('{{ product.id }}', '{{ product.selected_or_first_available_variant.id }}'),
      sku: '{{ product.selected_or_first_available_variant.sku }}',
      product_handle: '{{ product.handle }}',
      variant_title: {{ product.selected_or_first_available_variant.title | json }},
      product_type: {{ product.type | json }},
      index: {{ forloop.index0 }}
    });
    {% endif %}
    {% endfor %}

    window.dataLayer.push({
      event: 'search',
      search_term: {{ search.terms | json }},
      search_results_count: {{ search.results_count }}
    });

    if (items.length > 0) {
      window.dataLayer.push({
        event: 'view_search_results',
        search_term: {{ search.terms | json }},
        ecommerce: {
          items: items
        }
      });
    }

    log('search events pushed (enhanced)', {
      term: {{ search.terms | json }},
      results: items.length,
      total_results: {{ search.results_count }}
    });
  })();

  {% when 'product' %}
  // ENHANCED VIEW_ITEM event with full product context
  (function() {
    try {
      var productData = {{ product | json }};

      var selectedVariant = productData.selected_or_first_available_variant ||
                           productData.selected_variant ||
                           (productData.variants && productData.variants[0]);

      if (!selectedVariant) {
        log('ERROR: No variant found for product', productData);
        return;
      }

      // Enhanced: Extract category from collections
      var categoryId = '';
      var categoryName = '';
      var categoryHandle = '';
      {% if product.collections.size > 0 %}
      categoryId = '{{ product.collections.last.id }}';
      categoryName = {{ product.collections.last.title | json }};
      categoryHandle = '{{ product.collections.last.handle }}';
      {% endif %}

      window.dataLayer.push({
        event: 'view_item',
        view_type: 'pdp',
        ecommerce: {
          currency: page_data.currency,
          value: parsePrice(selectedVariant.price / 100),
          items: [{
            item_id: String(selectedVariant.id),
            item_name: productData.title,
            item_brand: productData.vendor,
            item_category: productData.type,
            item_variant: selectedVariant.title,
            price: parsePrice(selectedVariant.price / 100),
            currency: page_data.currency,
            product_id: String(productData.id),
            variant_id: String(selectedVariant.id),
            g_product_id: generateGoogleProductId(productData.id, selectedVariant.id),
            sku: selectedVariant.sku,
            product_handle: '{{ product.handle }}',
            product_type: productData.type,
            category_id: categoryId,
            category_name: categoryName,
            category_handle: categoryHandle
          }]
        }
      });

      log('view_item pushed (enhanced)', {
        product: productData.title,
        view_type: 'pdp',
        category: categoryName
      });
    } catch (error) {
      log('ERROR in view_item event:', error);
    }
  })();

  {% when 'cart' %}
  // ENHANCED VIEW_CART event with totals
  (function() {
    var items = [];
    var totalValue = 0;
    var totalQuantity = 0;

    {% for item in cart.items %}
    var itemData = formatProductItem({{ item | json }}, {{ forloop.index0 }});
    items.push(itemData);
    totalValue += (itemData.price || 0) * (itemData.quantity || 1);
    totalQuantity += (itemData.quantity || 0);
    {% endfor %}

    window.dataLayer.push({
      event: 'view_cart',
      ecommerce: {
        currency: page_data.currency,
        value: parsePrice(totalValue),
        items: items
      },
      cart_total_value: parsePrice(totalValue),
      cart_total_quantity: totalQuantity
    });

    log('view_cart pushed (enhanced)', {
      items_count: items.length,
      total_value: parsePrice(totalValue),
      total_quantity: totalQuantity
    });
  })();

  {% endcase %}

  // ==========================================================================
  // ENHANCED CLICK EVENT DELEGATION
  // ==========================================================================

  document.addEventListener('click', function(event) {
    var path = event.path || (event.composedPath && event.composedPath()) || [];

    // Check for quick view button
    {% if template.name == 'collection' or template.name == 'search' %}
    var quickViewBtn = findElementInPath(path, CONFIG.selectors.quickViewButton);
    if (quickViewBtn) {
      handleQuickViewClick(quickViewBtn);
    }
    {% endif %}

    // Check for add to cart button
    {% if template.name == 'product' %}
    var addToCartBtn = findElementInPath(path, CONFIG.selectors.addToCartButton);
    if (addToCartBtn) {
      handleAddToCartClick(addToCartBtn, event);
    }
    {% elsif template.name == 'collection' or template.name == 'search' %}
    var addToCartBtn = findElementInPath(path, CONFIG.selectors.addToCartButton);
    if (addToCartBtn) {
      var handledByQuickView = handleQuickViewAddToCart(addToCartBtn);
      if (!handledByQuickView) {
        handleAddToCartClick(addToCartBtn, event);
      }
    }
    {% endif %}

    // Check for checkout button
    var checkoutBtn = findElementInPath(path, CONFIG.selectors.checkoutButton);
    if (checkoutBtn) {
      handleCheckoutClick();
      return;
    }

    // Check for remove from cart
    var removeBtn = findElementInPath(path, CONFIG.selectors.removeButton);
    if (removeBtn) {
      if (removeBtn._removeProcessed && Date.now() - removeBtn._removeProcessed < 100) {
        return;
      }
      removeBtn._removeProcessed = Date.now();
      log('Remove button clicked', removeBtn);
      handleRemoveFromCart(removeBtn);
      return;
    }

    // Check for product click
    {% if template.name == 'collection' or template.name == 'search' %}
    var productLink = findElementInPath(path, [CONFIG.selectors.productLink]);
    if (productLink && productLink.href && productLink.href.includes('/products/')) {
      handleProductClick(productLink);
      return;
    }
    {% endif %}
  });

  // ==========================================================================
  // CHECKOUT CLICK HANDLER
  // ==========================================================================

  function handleCheckoutClick() {
    log('Checkout button clicked - tracking handled by checkout pixel');
  }

  // ==========================================================================
  // ENHANCED ADD TO CART HANDLERS
  // ==========================================================================

  {% if template.name == 'collection' or template.name == 'search' %}
  function fetchAndPushQuickViewAddToCart(productHandle, variantId, quantity, listAttribution) {
    log('Fetching product by handle:', productHandle);

    fetch('/products/' + productHandle + '.js')
      .then(function(response) { return response.json(); })
      .then(function(productData) {
        var selectedVariant = productData.variants.find(function(v) {
          return String(v.id) === String(variantId);
        }) || productData.variants[0];

        var price = parsePrice(selectedVariant.price / 100);
        var value = parsePrice(price * quantity);

        var item = {
          item_id: String(selectedVariant.id),
          item_name: productData.title,
          item_brand: productData.vendor,
          item_category: productData.type,
          item_variant: selectedVariant.title,
          price: price,
          quantity: quantity,
          currency: page_data.currency,
          product_id: String(productData.id),
          variant_id: String(selectedVariant.id),
          g_product_id: generateGoogleProductId(productData.id, selectedVariant.id),
          sku: selectedVariant.sku,
          product_handle: productData.handle,
          product_type: productData.type,
          item_list_id: listAttribution.item_list_id,
          item_list_name: listAttribution.item_list_name
        };

        window.dataLayer.push({
          event: 'add_to_cart',
          context: 'quick_view',
          ecommerce: {
            currency: page_data.currency,
            value: value,
            items: [item]
          }
        });

        log('add_to_cart pushed (enhanced quick_view)', {
          product: productData.title,
          variant: selectedVariant.title,
          quantity: quantity,
          value: value,
          list: item.item_list_name
        });
      })
      .catch(function(error) {
        log('Error fetching product data for quick view add to cart', error);
      });
  }

  function handleQuickViewAddToCart(button) {
    log('Add to cart clicked in quick view modal', button);

    var isQuickView = button.id && button.id.includes('quick-view');
    if (!isQuickView) {
      log('Not a quick view modal, skipping');
      return false;
    }

    var form = button.closest('form[action*="/cart/add"]') || button.form;
    if (!form) {
      log('Could not find product form in quick view');
      return false;
    }

    var variantInput = form.querySelector('input[name="id"]') || form.querySelector('select[name="id"]');
    if (!variantInput || !variantInput.value) {
      log('Could not find variant ID in quick view form');
      return false;
    }
    var variantId = variantInput.value;

    var quantityInput = form.querySelector('input[name="quantity"]');
    var quantity = quantityInput ? parseInt(quantityInput.value) || 1 : 1;

    var listAttribution = null;
    if (isSessionStorageAvailable()) {
      try {
        var attribution = JSON.parse(sessionStorage.getItem('jy_list_attribution') || '{}');
        listAttribution = attribution[String(variantId)];
      } catch(e) {
        log('Error reading list attribution', e);
      }
    }

    if (!listAttribution) {
      log('No list attribution found for variant', variantId);
      return false;
    }

    var productHandle = null;
    var productInfo = button.closest('product-info') ||
                      document.querySelector('product-info[data-url]');

    if (productInfo) {
      try {
        var productUrl = productInfo.getAttribute('data-url');
        if (productUrl) {
          var urlParts = productUrl.split('/products/');
          if (urlParts.length > 1) {
            productHandle = urlParts[1].split('?')[0].split('/')[0];
            log('Extracted product handle from data-url:', productHandle);
          }
        }
      } catch(e) {
        log('Error extracting product handle', e);
      }
    }

    if (!productHandle) {
      log('Could not extract product handle from quick view modal');
      return false;
    }

    fetchAndPushQuickViewAddToCart(productHandle, variantId, quantity, listAttribution);
    return true;
  }
  {% endif %}

  {% if template.name == 'product' %}
  // ENHANCED Product page add to cart handler
  function handleAddToCartClick(button, event) {
    log('Add to cart button clicked on product page', button);

    var form = button.closest('form[action*="/cart/add"]') || button.form;
    if (!form) {
      log('Could not find product form');
      return;
    }

    var isQuickView = button.id && button.id.includes('quick-view');
    var context = isQuickView ? 'quick_view' : 'pdp';

    var productData = {{ product | json }};

    var variantInput = form.querySelector('input[name="id"]') || form.querySelector('select[name="id"]');
    var variantId = variantInput ? variantInput.value : productData.selected_or_first_available_variant.id;

    var quantityInput = form.querySelector('input[name="quantity"]');
    var quantity = quantityInput ? parseInt(quantityInput.value) || 1 : 1;

    var selectedVariant = productData.variants.find(function(v) {
      return String(v.id) === String(variantId);
    }) || productData.selected_or_first_available_variant;

    var price = parsePrice(selectedVariant.price / 100);
    var value = parsePrice(price * quantity);

    // Enhanced: Extract category data
    var categoryId = '';
    var categoryName = '';
    var categoryHandle = '';
    {% if product.collections.size > 0 %}
    categoryId = '{{ product.collections.last.id }}';
    categoryName = {{ product.collections.last.title | json }};
    categoryHandle = '{{ product.collections.last.handle }}';
    {% endif %}

    var item = {
      item_id: String(selectedVariant.id),
      item_name: productData.title,
      item_brand: productData.vendor,
      item_category: productData.type,
      item_variant: selectedVariant.title,
      price: price,
      quantity: quantity,
      currency: page_data.currency,
      product_id: String(productData.id),
      variant_id: String(selectedVariant.id),
      g_product_id: generateGoogleProductId(productData.id, selectedVariant.id),
      sku: selectedVariant.sku,
      product_handle: '{{ product.handle }}',
      product_type: productData.type,
      category_id: categoryId,
      category_name: categoryName,
      category_handle: categoryHandle
    };

    if (isQuickView) {
      try {
        var attribution = JSON.parse(sessionStorage.getItem('jy_list_attribution') || '{}');
        var variantAttribution = attribution[String(selectedVariant.id)];
        if (variantAttribution) {
          item.item_list_id = variantAttribution.item_list_id;
          item.item_list_name = variantAttribution.item_list_name;
        }
      } catch(e) {
        log('Error reading list attribution for quick view add to cart', e);
      }
    }

    window.dataLayer.push({
      event: 'add_to_cart',
      context: context,
      ecommerce: {
        currency: page_data.currency,
        value: value,
        items: [item]
      }
    });

    log('add_to_cart pushed (enhanced ' + context + ')', {
      product: productData.title,
      variant: selectedVariant.title,
      quantity: quantity,
      value: value,
      category: categoryName,
      list: item.item_list_name || 'none'
    });
  }
  {% elsif template.name == 'collection' %}
  // ENHANCED Collection page quick-add handler
  function handleAddToCartClick(button, event) {
    log('Add to cart button clicked on collection page', button);

    var form = button.closest('form[action*="/cart/add"]') || button.form;
    if (!form) {
      log('Could not find product form');
      return;
    }

    var productIdInput = form.querySelector('input[name="product-id"]') ||
                         form.querySelector('[data-product-id]') ||
                         form.querySelector('input[name="id"]');

    if (!productIdInput) {
      log('Could not find product ID in form');
      return;
    }

    var productId = productIdInput.value || productIdInput.getAttribute('data-product-id');

    var variantInput = form.querySelector('input[name="id"]') || form.querySelector('select[name="id"]');
    var variantId = variantInput ? variantInput.value : null;

    var quantityInput = form.querySelector('input[name="quantity"]');
    var quantity = quantityInput ? parseInt(quantityInput.value) || 1 : 1;

    var collectionProducts = [
      {% for product in collection.products %}
      {
        id: '{{ product.id }}',
        title: {{ product.title | json }},
        handle: '{{ product.handle }}',
        vendor: {{ product.vendor | json }},
        type: {{ product.type | json }},
        variant_id: '{{ product.selected_or_first_available_variant.id }}',
        variant_title: {{ product.selected_or_first_available_variant.title | json }},
        price: {{ product.variants.first.price | times: 0.01 }},
        sku: '{{ product.selected_or_first_available_variant.sku }}'
      }{% unless forloop.last %},{% endunless %}
      {% endfor %}
    ];

    var product = collectionProducts.find(function(p) {
      return String(p.id) === String(productId);
    });

    if (!product) {
      log('Could not find product in collection', productId);
      return;
    }

    var price = parsePrice(product.price);
    var value = parsePrice(price * quantity);
    var finalVariantId = variantId || product.variant_id;

    window.dataLayer.push({
      event: 'add_to_cart',
      context: 'collection_quick_add',
      ecommerce: {
        currency: page_data.currency,
        value: value,
        items: [{
          item_id: String(finalVariantId),
          item_name: product.title,
          item_brand: product.vendor,
          item_category: product.type,
          item_variant: product.variant_title,
          item_list_name: page_data.collection_title,
          item_list_id: page_data.collection_id,
          price: price,
          quantity: quantity,
          currency: page_data.currency,
          product_id: String(product.id),
          variant_id: String(finalVariantId),
          g_product_id: generateGoogleProductId(product.id, finalVariantId),
          sku: product.sku,
          product_handle: product.handle,
          product_type: product.type,
          category_handle: '{{ collection.handle }}',
          category_id: '{{ collection.id }}',
          category_name: {{ collection.title | json }}
        }]
      }
    });

    log('add_to_cart pushed (enhanced collection quick-add)', {
      product: product.title,
      quantity: quantity,
      value: value,
      category: {{ collection.title | json }}
    });

    saveListAttribution(finalVariantId, page_data.collection_id, page_data.collection_title);
  }
  {% endif %}

  // ==========================================================================
  // ENHANCED REMOVE FROM CART HANDLER
  // ==========================================================================

  function handleRemoveFromCart(button) {
    log('Remove button clicked (enhanced)', button);

    var cartItem = button.closest('.cart-item, [data-cart-item], tr[data-key], li[data-key], [data-line-item], tr, li');

    if (!cartItem) {
      log('Could not find cart item element');
      cartItem = null;
    } else {
      log('Found cart item element', cartItem);
    }

    var variantId = null;

    if (cartItem) {
      variantId = cartItem.getAttribute('data-variant-id') ||
                  cartItem.getAttribute('data-key') ||
                  cartItem.getAttribute('data-line-item');
    }

    if (!variantId) {
      variantId = button.getAttribute('data-variant-id');
    }

    if (!variantId && button.getAttribute('href')) {
      var href = button.getAttribute('href');
      var match = href.match(/[?&]id=(\d+)(?::|&)/);
      if (match && match[1]) {
        variantId = match[1];
        log('Extracted variant ID from href', variantId);
      } else {
        match = href.match(/[?&]id=(\d+)/);
        if (match && match[1]) {
          variantId = match[1];
          log('Extracted variant ID from href (fallback)', variantId);
        }
      }
    }

    if (!variantId) {
      log('Could not extract variant ID from cart item or button');
      if (cartItem) {
        log('Cart item attributes:', Array.from(cartItem.attributes).map(function(a) { return a.name + '=' + a.value; }));
      }
      log('Button attributes:', Array.from(button.attributes).map(function(a) { return a.name + '=' + a.value; }));
      return;
    }

    log('Extracted variant ID:', variantId);

    fetch('/cart.js')
      .then(function(response) { return response.json(); })
      .then(function(cart) {
        log('Cart fetched for remove, looking for variant:', variantId);

        var item = cart.items.find(function(i) {
          return String(i.variant_id) === String(variantId) ||
                 String(i.id) === String(variantId) ||
                 String(i.key) === String(variantId);
        });

        if (item) {
          var formattedItem = formatProductItem(item, 0);

          window.dataLayer.push({
            event: 'remove_from_cart',
            ecommerce: {
              currency: cart.currency,
              value: parsePrice(formattedItem.price * formattedItem.quantity),
              items: [formattedItem]
            }
          });

          log('remove_from_cart pushed (enhanced)', formattedItem);
        } else {
          log('Could not find item in cart with variant ID:', variantId);
          log('Available cart items:', cart.items.map(function(i) { return i.variant_id; }));
        }
      })
      .catch(function(error) {
        log('Error fetching cart for remove', error);
      });
  }

  // ==========================================================================
  // ENHANCED QUICK VIEW HANDLER
  // ==========================================================================

  {% if template.name == 'collection' %}
  function handleQuickViewClick(button) {
    log('Quick view button clicked (enhanced)', button);

    var ariaControls = button.getAttribute('aria-controls');
    var productId = null;

    if (ariaControls && ariaControls.startsWith('QuickView-')) {
      var parts = ariaControls.split('-');
      if (parts.length >= 2) {
        productId = parts[1];
      }
    }

    if (!productId) {
      log('Could not extract product ID from quick view button');
      return;
    }

    var products = [
      {% for product in collection.products %}
      {
        id: '{{ product.id }}',
        title: {{ product.title | json }},
        vendor: {{ product.vendor | json }},
        type: {{ product.type | json }},
        variant_id: '{{ product.selected_or_first_available_variant.id }}',
        variant_title: {{ product.selected_or_first_available_variant.title | json }},
        price: {{ product.variants.first.price | times: 0.01 }},
        sku: '{{ product.selected_or_first_available_variant.sku }}',
        product_handle: '{{ product.handle }}',
        index: {{ forloop.index0 }}
      }{% unless forloop.last %},{% endunless %}
      {% endfor %}
    ];

    var product = products.find(function(p) {
      return String(p.id) === String(productId);
    });

    if (!product) {
      log('Could not find product in collection', productId);
      return;
    }

    window.dataLayer.push({
      event: 'view_item',
      view_type: 'quick_view',
      ecommerce: {
        currency: page_data.currency,
        value: parsePrice(product.price),
        items: [{
          item_id: product.variant_id,
          item_name: product.title,
          item_brand: product.vendor,
          item_category: product.type,
          item_variant: product.variant_title,
          price: product.price,
          currency: page_data.currency,
          product_id: product.id,
          variant_id: product.variant_id,
          g_product_id: generateGoogleProductId(product.id, product.variant_id),
          sku: product.sku,
          product_handle: product.product_handle,
          product_type: product.type,
          category_handle: '{{ collection.handle }}',
          category_id: '{{ collection.id }}',
          category_name: {{ collection.title | json }},
          item_list_id: '{{ collection.id }}',
          item_list_name: {{ collection.title | json }},
          index: product.index
        }]
      }
    });

    log('view_item (enhanced quick_view) pushed', {
      product: product.title,
      view_type: 'quick_view',
      category: {{ collection.title | json }}
    });

    saveListAttribution(product.variant_id, '{{ collection.id }}', {{ collection.title | json }});
  }
  {% elsif template.name == 'search' %}
  function handleQuickViewClick(button) {
    log('Quick view button clicked (enhanced)', button);

    var ariaControls = button.getAttribute('aria-controls');
    var productId = null;

    if (ariaControls && ariaControls.startsWith('QuickView-')) {
      var parts = ariaControls.split('-');
      if (parts.length >= 2) {
        productId = parts[1];
      }
    }

    if (!productId) {
      log('Could not extract product ID from quick view button');
      return;
    }

    var products = [
      {% for product in search.results %}
      {% if product.object_type == 'product' %}
      {
        id: '{{ product.id }}',
        title: {{ product.title | json }},
        vendor: {{ product.vendor | json }},
        type: {{ product.type | json }},
        variant_id: '{{ product.selected_or_first_available_variant.id }}',
        variant_title: {{ product.selected_or_first_available_variant.title | json }},
        price: {{ product.variants.first.price | times: 0.01 }},
        product_handle: '{{ product.handle }}',
        index: {{ forloop.index0 }}
      }{% unless forloop.last %},{% endunless %}
      {% endif %}
      {% endfor %}
    ];

    var product = products.find(function(p) {
      return String(p.id) === String(productId);
    });

    if (!product) {
      log('Could not find product in search results', productId);
      return;
    }

    var searchTerm = {{ search.terms | json }};
    var listName = searchTerm ? 'Search: ' + searchTerm : 'Search Results';

    window.dataLayer.push({
      event: 'view_item',
      view_type: 'quick_view',
      ecommerce: {
        currency: page_data.currency,
        value: parsePrice(product.price),
        items: [{
          item_id: product.variant_id,
          item_name: product.title,
          item_brand: product.vendor,
          item_category: product.type,
          item_variant: product.variant_title,
          price: product.price,
          currency: page_data.currency,
          product_id: product.id,
          variant_id: product.variant_id,
          product_handle: product.product_handle,
          product_type: product.type,
          item_list_id: 'search_results',
          item_list_name: listName,
          index: product.index
        }]
      }
    });

    log('view_item (enhanced quick_view) pushed', {
      product: product.title,
      view_type: 'quick_view',
      search_term: searchTerm
    });

    saveListAttribution(product.variant_id, 'search_results', listName);
  }
  {% endif %}

  // ==========================================================================
  // ENHANCED PRODUCT CLICK HANDLER
  // ==========================================================================

  {% if template.name == 'collection' %}
  function handleProductClick(link) {
    var handle = link.href.split('/products/')[1];
    if (!handle) return;

    var products = [
      {% for product in collection.products %}
      {
        handle: '{{ product.handle }}',
        id: '{{ product.id }}',
        title: {{ product.title | json }},
        vendor: {{ product.vendor | json }},
        type: {{ product.type | json }},
        variant_id: '{{ product.selected_or_first_available_variant.id }}',
        variant_title: {{ product.selected_or_first_available_variant.title | json }},
        price: {{ product.variants.first.price | times: 0.01 }},
        sku: '{{ product.selected_or_first_available_variant.sku }}',
        product_handle: '{{ product.handle }}',
        index: {{ forloop.index0 }}
      }{% unless forloop.last %},{% endunless %}
      {% endfor %}
    ];

    var product = products.find(function(p) { return p.handle === handle.split('?')[0]; });

    if (product) {
      window.dataLayer.push({
        event: 'select_item',
        ecommerce: {
          item_list_id: '{{ collection.id }}',
          item_list_name: {{ collection.title | json }},
          items: [{
            item_id: product.variant_id,
            item_name: product.title,
            item_brand: product.vendor,
            item_category: product.type,
            item_variant: product.variant_title,
            price: product.price,
            currency: page_data.currency,
            product_id: product.id,
            variant_id: product.variant_id,
            g_product_id: generateGoogleProductId(product.id, product.variant_id),
            sku: product.sku,
            product_handle: product.product_handle,
            product_type: product.type,
            category_handle: '{{ collection.handle }}',
            category_id: '{{ collection.id }}',
            category_name: {{ collection.title | json }},
            item_list_id: '{{ collection.id }}',
            item_list_name: {{ collection.title | json }},
            index: product.index
          }]
        }
      });

      log('select_item pushed (enhanced)', {
        product: product.title,
        category: {{ collection.title | json }}
      });

      saveListAttribution(product.variant_id, '{{ collection.id }}', {{ collection.title | json }});
    }
  }
  {% elsif template.name == 'search' %}
  function handleProductClick(link) {
    var handle = link.href.split('/products/')[1];
    if (!handle) return;

    var products = [
      {% for product in search.results %}
      {% if product.object_type == 'product' %}
      {
        handle: '{{ product.handle }}',
        id: '{{ product.id }}',
        title: {{ product.title | json }},
        vendor: {{ product.vendor | json }},
        type: {{ product.type | json }},
        variant_id: '{{ product.selected_or_first_available_variant.id }}',
        variant_title: {{ product.selected_or_first_available_variant.title | json }},
        price: {{ product.variants.first.price | times: 0.01 }},
        sku: '{{ product.selected_or_first_available_variant.sku }}',
        product_handle: '{{ product.handle }}',
        index: {{ forloop.index0 }}
      }{% unless forloop.last %},{% endunless %}
      {% endif %}
      {% endfor %}
    ];

    var product = products.find(function(p) { return p.handle === handle.split('?')[0]; });

    if (product) {
      var searchTerm = {{ search.terms | json }};
      var listName = searchTerm ? 'Search: ' + searchTerm : 'Search Results';

      window.dataLayer.push({
        event: 'select_item',
        ecommerce: {
          item_list_id: 'search_results',
          item_list_name: listName,
          items: [{
            item_id: product.variant_id,
            item_name: product.title,
            item_brand: product.vendor,
            item_category: product.type,
            item_variant: product.variant_title,
            price: product.price,
            currency: page_data.currency,
            product_id: product.id,
            variant_id: product.variant_id,
            g_product_id: generateGoogleProductId(product.id, product.variant_id),
            sku: product.sku,
            product_handle: product.product_handle,
            product_type: product.type,
            item_list_id: 'search_results',
            item_list_name: listName,
            index: product.index
          }]
        }
      });

      log('select_item pushed (enhanced)', {
        product: product.title,
        search_term: searchTerm
      });

      saveListAttribution(product.variant_id, 'search_results', listName);
    }
  }
  {% endif %}

  // ==========================================================================
  // ENHANCED CART DRAWER TRACKING
  // ==========================================================================

  (function() {
    var drawerSelectors = CONFIG.selectors.cartDrawer;
    var drawerObserver = null;
    var foundDrawer = null;
    var lastDrawerState = null;
    var drawerCheckTimeout = null;

    function checkCartDrawer(trigger) {
      if (drawerCheckTimeout) {
        clearTimeout(drawerCheckTimeout);
        drawerCheckTimeout = null;
      }

      for (var i = 0; i < drawerSelectors.length; i++) {
        var drawer = document.querySelector(drawerSelectors[i]);
        if (drawer) {
          foundDrawer = drawer;

          var isVisible = !drawer.hasAttribute('hidden') &&
                         !drawer.classList.contains('hidden') &&
                         drawer.style.display !== 'none';

          if (isVisible && lastDrawerState !== 'visible') {
            lastDrawerState = 'visible';
            log('Cart drawer opened, tracking view (enhanced)');
            trackCartDrawerView(trigger || 'auto');
            return true;
          } else if (!isVisible && lastDrawerState === 'visible') {
            lastDrawerState = 'hidden';
            log('Cart drawer closed');
          }
        }
      }
      return false;
    }

    function trackCartDrawerView(trigger) {
      if (window._cartDrawerTracked && Date.now() - window._cartDrawerTracked < 3000) {
        log('Debounced view_cart drawer event (too soon)');
        return;
      }
      window._cartDrawerTracked = Date.now();

      fetch('/cart.js')
        .then(function(response) { return response.json(); })
        .then(function(cart) {
          var items = cart.items.map(function(item, index) {
            return formatProductItem(item, index);
          });
          var totalValue = items.reduce(function(sum, item) {
            return sum + (item.price || 0) * (item.quantity || 1);
          }, 0);
          var totalQuantity = items.reduce(function(sum, item) {
            return sum + (item.quantity || 0);
          }, 0);

          window.dataLayer.push({
            event: 'view_cart',
            cart_type: 'drawer',
            trigger: trigger,
            ecommerce: {
              currency: cart.currency,
              value: parsePrice(totalValue),
              items: items
            },
            cart_total_value: parsePrice(totalValue),
            cart_total_quantity: totalQuantity
          });

          log('view_cart (enhanced drawer) pushed', {
            trigger: trigger,
            items_count: items.length,
            value: totalValue,
            quantity: totalQuantity
          });
        })
        .catch(function(error) {
          log('Error fetching cart for drawer view', error);
        });
    }

    function setupDrawerObserver() {
      if (drawerObserver) return;

      drawerObserver = new MutationObserver(function(mutations) {
        if (drawerCheckTimeout) {
          clearTimeout(drawerCheckTimeout);
        }
        drawerCheckTimeout = setTimeout(function() {
          checkCartDrawer('auto');
        }, 100);
      });

      log('Setting up cart drawer observers for selectors:', drawerSelectors);
      drawerSelectors.forEach(function(selector) {
        var drawer = document.querySelector(selector);
        if (drawer) {
          log('Observing drawer element:', selector);
          drawerObserver.observe(drawer, {
            attributes: true,
            attributeFilter: ['hidden', 'class', 'style', 'open']
          });
        }
      });

      if (!foundDrawer) {
        log('WARNING: No cart drawer element found with configured selectors');
      }
    }

    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', setupDrawerObserver);
    } else {
      setupDrawerObserver();
    }

    document.addEventListener('click', function(event) {
      var target = event.target;
      var cartButton = target.closest('a[href="/cart"], a[href*="#cart"], button[aria-controls*="cart"], [data-cart-trigger]') ||
                       (target.classList && (target.classList.contains('cart-icon') || target.classList.contains('cart-button')));

      if (cartButton) {
        log('Cart icon clicked - manual drawer open');
        window._nextDrawerTrigger = 'manual';
        setTimeout(function() {
          window._nextDrawerTrigger = null;
        }, 500);
      }
    });

    var originalCheckDrawer = checkCartDrawer;
    checkCartDrawer = function(defaultTrigger) {
      var trigger = window._nextDrawerTrigger || defaultTrigger || 'auto';
      if (window._nextDrawerTrigger) {
        window._nextDrawerTrigger = null;
      }
      return originalCheckDrawer(trigger);
    };

    var cartEvents = [
      'cart:refresh',
      'cart:open',
      'cart-drawer:open',
      'drawer:open',
      'shopify:section:load'
    ];

    cartEvents.forEach(function(eventName) {
      document.addEventListener(eventName, function() {
        log('Cart event detected:', eventName);
        setTimeout(function() { checkCartDrawer('auto'); }, 100);
      });
    });
  })();

  // ==========================================================================
  // INITIALIZATION COMPLETE
  // ==========================================================================

  log('JY Insights Gold Plus ENHANCED tracking initialized', {
    version: CONFIG.version,
    page_type: page_data.page_type,
    customer_logged_in: user_data.logged_in,
    customer_type: user_data.customer_type
  });

})();
</script>
