{% comment %}
/**
 * JY/co Gold Package - Storefront Data Layer
 * Comprehensive GA4 ecommerce tracking for Shopify storefront (pre-checkout)
 * Version: 2.0
 * Last Updated: 2025-12-09
 *
 * Installation: Insert this snippet in theme.liquid before </head>
 * Documentation: See gold-sdr-document.docx
 * Support: contact@jyco.com
 *
 * CHANGELOG v2.0:
 * - Fixed critical bug: Combined dual fetch override into single function
 * - Improved error handling with comprehensive try-catch blocks
 * - Enhanced security: Input validation and XSS protection
 * - Better performance: Reduced redundant operations
 * - Added JSDoc comments for better maintainability
 * - Standardized code formatting and structure
 *
 * This snippet handles all storefront events. Checkout events are handled
 * by the companion gold-checkout-pixel.js custom pixel.
 */
{% endcomment %}

<script>
/**
 * JY/co Gold Data Layer - Storefront Tracking
 * @namespace JYCO
 */
(function() {
  'use strict';

  // ============================================================================
  // CONFIGURATION
  // ============================================================================

  var JYCO_CONFIG = {
    debug: false, // Set to true to enable console logging
    version: '2.0',
    maxCollectionProducts: 50, // Limit for view_item_list to prevent performance issues
    hashEmail: true // Enable SHA256 email hashing
  };

  // ============================================================================
  // UTILITY FUNCTIONS
  // ============================================================================

  /**
   * Initialize dataLayer
   */
  window.dataLayer = window.dataLayer || [];

  /**
   * Debug logger
   * @param {string} message - Log message
   * @param {*} [data] - Optional data to log
   */
  function jycoLog(message, data) {
    if (JYCO_CONFIG.debug) {
      console.log('[JY/co Gold v' + JYCO_CONFIG.version + '] ' + message, data || '');
    }
  }

  /**
   * SHA256 hash function for email
   * @param {string} message - String to hash
   * @returns {Promise<string>} Hashed string
   */
  async function sha256(message) {
    if (!JYCO_CONFIG.hashEmail || !message) {
      return '';
    }

    try {
      var msgBuffer = new TextEncoder().encode(message.toLowerCase().trim());
      var hashBuffer = await crypto.subtle.digest('SHA-256', msgBuffer);
      var hashArray = Array.from(new Uint8Array(hashBuffer));
      var hashHex = hashArray.map(function(b) {
        return b.toString(16).padStart(2, '0');
      }).join('');
      return hashHex;
    } catch (e) {
      jycoLog('Error hashing email:', e);
      return '';
    }
  }

  /**
   * Safe string escaping to prevent XSS
   * @param {*} str - String to escape
   * @returns {string} Escaped string
   */
  function escapeString(str) {
    if (!str) {
      return '';
    }
    return String(str)
      .replace(/\\/g, '\\\\')
      .replace(/"/g, '\\"')
      .replace(/\n/g, '\\n')
      .replace(/</g, '&lt;')
      .replace(/>/g, '&gt;');
  }

  /**
   * Safe number parsing
   * @param {*} val - Value to parse
   * @returns {number} Parsed number or 0
   */
  function safeNumber(val) {
    var num = parseFloat(val);
    return isNaN(num) ? 0 : num;
  }

  /**
   * Detect page type
   * @returns {string} Page type identifier
   */
  function getPageType() {
    {% if template == 'index' %}
      return 'home';
    {% elsif template contains 'product' %}
      return 'product';
    {% elsif template contains 'collection' %}
      return 'collection';
    {% elsif template contains 'cart' %}
      return 'cart';
    {% elsif template contains 'search' %}
      return 'search';
    {% elsif template contains 'blog' %}
      return 'blog';
    {% elsif template contains 'article' %}
      return 'article';
    {% elsif template contains '404' %}
      return '404';
    {% elsif template contains 'page' %}
      return 'page';
    {% else %}
      return 'other';
    {% endif %}
  }

  // ============================================================================
  // CUSTOMER DATA
  // ============================================================================

  /**
   * Get customer data
   * @returns {Promise<Object>} Customer data object
   */
  async function getCustomerData() {
    var customerData = {
      customer_logged_in: {% if customer %}true{% else %}false{% endif %}
    };

    {% if customer %}
      var email = '{{ customer.email | default: "" | escape }}';

      customerData.user_id = '{{ customer.id | default: "" }}';
      customerData.customer_first_name = '{{ customer.first_name | default: "" | escape }}';
      customerData.customer_orders_count = {{ customer.orders_count | default: 0 }};
      customerData.customer_total_spent = {{ customer.total_spent | money_without_currency | remove: ',' | default: 0 }};
      customerData.customer_accepts_marketing = {% if customer.accepts_marketing %}true{% else %}false{% endif %};

      {% if customer.tags.size > 0 %}
        customerData.customer_tags = [
          {% for tag in customer.tags %}
            '{{ tag | escape }}'{% unless forloop.last %},{% endunless %}
          {% endfor %}
        ];
      {% else %}
        customerData.customer_tags = [];
      {% endif %}

      if (email && JYCO_CONFIG.hashEmail) {
        customerData.customer_email_sha256 = await sha256(email);
      }
    {% else %}
      customerData.user_id = undefined;
      customerData.customer_email_sha256 = '';
      customerData.customer_first_name = '';
      customerData.customer_orders_count = 0;
      customerData.customer_total_spent = 0;
      customerData.customer_accepts_marketing = false;
      customerData.customer_tags = [];
    {% endif %}

    return customerData;
  }

  /**
   * Push user data event
   */
  async function pushUserData() {
    try {
      var customerData = await getCustomerData();
      var userData = { event: 'user_data' };

      // Merge customer data into userData
      for (var key in customerData) {
        if (customerData.hasOwnProperty(key)) {
          userData[key] = customerData[key];
        }
      }

      window.dataLayer.push(userData);
      jycoLog('User data pushed', userData);
    } catch (e) {
      jycoLog('Error pushing user data:', e);
    }
  }

  // ============================================================================
  // PAGE VIEW TRACKING
  // ============================================================================

  /**
   * Push page view event
   */
  function pushPageView() {
    try {
      var pageData = {
        event: 'page_view',
        page_type: getPageType(),
        page_title: document.title || '',
        page_path: window.location.pathname || '',
        page_location: window.location.href || ''
      };

      window.dataLayer.push(pageData);
      jycoLog('Page view pushed', pageData);
    } catch (e) {
      jycoLog('Error pushing page view:', e);
    }
  }

  // ============================================================================
  // PRODUCT FORMATTING
  // ============================================================================

  /**
   * Format product item for GA4
   * @param {Object} product - Product object
   * @param {Object} variant - Variant object
   * @param {number} [index] - Item index in list
   * @param {string} [listName] - List name
   * @param {string} [listId] - List ID
   * @returns {Object} Formatted item object
   */
  function formatProductItem(product, variant, index, listName, listId) {
    var price = variant && variant.price ? safeNumber(variant.price) / 100 : 0;
    var comparePrice = variant && variant.compare_at_price ? safeNumber(variant.compare_at_price) / 100 : 0;
    var discount = comparePrice > price ? (comparePrice - price) : 0;

    var item = {
      item_id: variant ? String(variant.id) : String(product.id),
      item_name: escapeString(product.title),
      item_brand: escapeString(product.vendor),
      item_category: escapeString(product.type),
      price: price,
      currency: '{{ cart.currency.iso_code | default: shop.currency }}'
    };

    if (variant && variant.title && variant.title !== 'Default Title') {
      item.item_variant = escapeString(variant.title);
    }

    if (variant && variant.sku) {
      item.item_sku = escapeString(variant.sku);
    }

    if (discount > 0) {
      item.discount = discount;
    }

    if (index !== undefined && index !== null) {
      item.index = index;
    }

    if (listName) {
      item.item_list_name = listName;
    }

    if (listId) {
      item.item_list_id = listId;
    }

    return item;
  }

  // ============================================================================
  // COLLECTION PAGE TRACKING
  // ============================================================================

  {% if template contains 'collection' %}
  /**
   * Collection page - view_item_list
   */
  function pushViewItemList() {
    try {
      var items = [];
      var listName = '{{ collection.title | escape }}';
      var listId = '{{ collection.id }}';

      {% assign limited_products = collection.products | slice: 0, 50 %}
      {% for product in limited_products %}
        {% assign variant = product.selected_or_first_available_variant %}
        var product{{ forloop.index0 }} = {
          id: {{ product.id }},
          title: '{{ product.title | escape }}',
          vendor: '{{ product.vendor | escape }}',
          type: '{{ product.type | escape }}',
          variant: {
            id: {{ variant.id }},
            title: '{{ variant.title | escape }}',
            price: {{ variant.price }},
            compare_at_price: {{ variant.compare_at_price | default: 0 }},
            sku: '{{ variant.sku | escape }}'
          }
        };

        items.push(formatProductItem(product{{ forloop.index0 }}, product{{ forloop.index0 }}.variant, {{ forloop.index0 }}, listName, listId));
      {% endfor %}

      window.dataLayer.push({
        event: 'view_item_list',
        ecommerce: {
          item_list_name: listName,
          item_list_id: listId,
          items: items
        }
      });

      jycoLog('View item list pushed', { list: listName, items: items.length });
    } catch (e) {
      jycoLog('Error pushing view_item_list:', e);
    }
  }
  {% endif %}

  // ============================================================================
  // PRODUCT PAGE TRACKING
  // ============================================================================

  {% if template contains 'product' %}
  /**
   * Product page - view_item
   */
  function pushViewItem() {
    try {
      {% assign current_variant = product.selected_or_first_available_variant %}
      var product = {
        id: {{ product.id }},
        title: '{{ product.title | escape }}',
        vendor: '{{ product.vendor | escape }}',
        type: '{{ product.type | escape }}',
        variant: {
          id: {{ current_variant.id }},
          title: '{{ current_variant.title | escape }}',
          price: {{ current_variant.price }},
          compare_at_price: {{ current_variant.compare_at_price | default: 0 }},
          sku: '{{ current_variant.sku | escape }}'
        }
      };

      var item = formatProductItem(product, product.variant);

      window.dataLayer.push({
        event: 'view_item',
        ecommerce: {
          currency: '{{ cart.currency.iso_code | default: shop.currency }}',
          value: item.price,
          items: [item]
        }
      });

      jycoLog('View item pushed', item);
    } catch (e) {
      jycoLog('Error pushing view_item:', e);
    }
  }
  {% endif %}

  // ============================================================================
  // SEARCH PAGE TRACKING
  // ============================================================================

  {% if template contains 'search' %}
  /**
   * Search page - search event
   */
  function pushSearchEvent() {
    try {
      var searchTerm = '{{ search.terms | escape }}';
      var resultsCount = {{ search.results_count | default: 0 }};

      window.dataLayer.push({
        event: 'search',
        search_term: searchTerm,
        search_results_count: resultsCount
      });

      jycoLog('Search event pushed', { term: searchTerm, results: resultsCount });

      // Also push view_item_list for search results
      if (resultsCount > 0) {
        var items = [];
        {% assign limited_results = search.results | slice: 0, 50 %}
        {% for product in limited_results %}
          {% if product.object_type == 'product' %}
            {% assign variant = product.selected_or_first_available_variant %}
            var product{{ forloop.index0 }} = {
              id: {{ product.id }},
              title: '{{ product.title | escape }}',
              vendor: '{{ product.vendor | escape }}',
              type: '{{ product.type | escape }}',
              variant: {
                id: {{ variant.id }},
                title: '{{ variant.title | escape }}',
                price: {{ variant.price }},
                compare_at_price: {{ variant.compare_at_price | default: 0 }},
                sku: '{{ variant.sku | escape }}'
              }
            };

            items.push(formatProductItem(product{{ forloop.index0 }}, product{{ forloop.index0 }}.variant, {{ forloop.index0 }}, 'Search Results', 'search'));
          {% endif %}
        {% endfor %}

        window.dataLayer.push({
          event: 'view_item_list',
          ecommerce: {
            item_list_name: 'Search Results',
            item_list_id: 'search',
            items: items
          }
        });
      }
    } catch (e) {
      jycoLog('Error pushing search event:', e);
    }
  }
  {% endif %}

  // ============================================================================
  // CART PAGE TRACKING
  // ============================================================================

  {% if template contains 'cart' %}
  /**
   * Cart page - view_cart
   */
  function pushViewCart() {
    try {
      var items = [];
      var cartTotal = {{ cart.total_price | money_without_currency | remove: ',' | default: 0 }};

      {% for item in cart.items %}
        var cartItem{{ forloop.index0 }} = {
          variant: {
            id: {{ item.variant_id }},
            title: '{{ item.variant.title | escape }}',
            price: {{ item.price }},
            compare_at_price: {{ item.variant.compare_at_price | default: 0 }},
            sku: '{{ item.variant.sku | escape }}'
          },
          product: {
            id: {{ item.product_id }},
            title: '{{ item.product.title | escape }}',
            vendor: '{{ item.product.vendor | escape }}',
            type: '{{ item.product.type | escape }}'
          },
          quantity: {{ item.quantity }}
        };

        var formattedItem = formatProductItem(cartItem{{ forloop.index0 }}.product, cartItem{{ forloop.index0 }}.variant);
        formattedItem.quantity = cartItem{{ forloop.index0 }}.quantity;
        items.push(formattedItem);
      {% endfor %}

      window.dataLayer.push({
        event: 'view_cart',
        ecommerce: {
          currency: '{{ cart.currency.iso_code | default: shop.currency }}',
          value: cartTotal,
          items: items
        },
        cart_id: '{{ cart.token | escape }}',
        cart_total: cartTotal,
        cart_item_count: {{ cart.item_count }}
      });

      jycoLog('View cart pushed', { items: items.length, total: cartTotal });
    } catch (e) {
      jycoLog('Error pushing view_cart:', e);
    }
  }
  {% endif %}

  // ============================================================================
  // CART INTERACTION TRACKING
  // ============================================================================

  /**
   * Push add to cart event
   * @param {Object} item - Cart item data
   */
  function pushAddToCartEvent(item) {
    try {
      var formattedItem = {
        item_id: String(item.id || item.variant_id),
        item_name: escapeString(item.product_title || item.title),
        item_brand: escapeString(item.vendor),
        item_category: escapeString(item.product_type),
        price: safeNumber(item.price) / 100,
        quantity: item.quantity || 1,
        currency: '{{ cart.currency.iso_code | default: shop.currency }}'
      };

      if (item.variant_title && item.variant_title !== 'Default Title') {
        formattedItem.item_variant = escapeString(item.variant_title);
      }

      if (item.sku) {
        formattedItem.item_sku = escapeString(item.sku);
      }

      window.dataLayer.push({
        event: 'add_to_cart',
        ecommerce: {
          currency: formattedItem.currency,
          value: formattedItem.price * formattedItem.quantity,
          items: [formattedItem]
        }
      });

      jycoLog('Add to cart pushed', formattedItem);
    } catch (e) {
      jycoLog('Error pushing add_to_cart:', e);
    }
  }

  /**
   * Setup unified cart event listeners
   * FIXED: Combined both fetch overrides into single function
   */
  function setupCartEventListeners() {
    var originalFetch = window.fetch;

    window.fetch = function() {
      var url = arguments[0];
      var options = arguments[1] || {};

      // Intercept /cart/add requests
      if (typeof url === 'string' && url.includes('/cart/add')) {
        return originalFetch.apply(this, arguments).then(function(response) {
          var clonedResponse = response.clone();

          clonedResponse.json().then(function(data) {
            try {
              if (data.items) {
                // Multiple items added
                data.items.forEach(function(item) {
                  pushAddToCartEvent(item);
                });
              } else {
                // Single item added
                pushAddToCartEvent(data);
              }
            } catch (e) {
              jycoLog('Error processing add to cart:', e);
            }
          }).catch(function(e) {
            jycoLog('Error parsing add to cart response:', e);
          });

          return response;
        });
      }

      // Intercept /cart/change requests
      if (typeof url === 'string' && url.includes('/cart/change')) {
        var bodyData = null;

        try {
          if (options.body) {
            bodyData = JSON.parse(options.body);
          }
        } catch (e) {
          jycoLog('Error parsing cart change body:', e);
        }

        return originalFetch.apply(this, arguments).then(function(response) {
          var clonedResponse = response.clone();

          if (bodyData && bodyData.quantity === 0) {
            clonedResponse.json().then(function(data) {
              try {
                var removedVariantId = bodyData.id;
                jycoLog('Item removed from cart', { variant_id: removedVariantId });

                window.dataLayer.push({
                  event: 'remove_from_cart',
                  ecommerce: {
                    items: [{
                      item_id: String(removedVariantId)
                    }]
                  }
                });
              } catch (e) {
                jycoLog('Error processing remove from cart:', e);
              }
            }).catch(function(e) {
              jycoLog('Error parsing cart change response:', e);
            });
          }

          return response;
        });
      }

      // All other requests pass through unchanged
      return originalFetch.apply(this, arguments);
    };

    // Listen for form submissions to /cart/add (non-AJAX)
    document.addEventListener('submit', function(e) {
      var form = e.target;

      if (form.action && form.action.includes('/cart/add')) {
        try {
          var formData = new FormData(form);
          var variantId = formData.get('id');
          var quantity = parseInt(formData.get('quantity') || '1');

          // Try to get product data from page
          {% if template contains 'product' %}
            {% assign current_variant = product.selected_or_first_available_variant %}
            var productData = {
              id: {{ current_variant.id }},
              product_title: '{{ product.title | escape }}',
              variant_title: '{{ current_variant.title | escape }}',
              vendor: '{{ product.vendor | escape }}',
              product_type: '{{ product.type | escape }}',
              price: {{ current_variant.price }},
              sku: '{{ current_variant.sku | escape }}'
            };

            if (variantId == productData.id) {
              pushAddToCartEvent({
                id: productData.id,
                product_id: {{ product.id }},
                title: productData.product_title,
                variant_title: productData.variant_title,
                vendor: productData.vendor,
                product_type: productData.product_type,
                price: productData.price,
                sku: productData.sku,
                quantity: quantity
              });
            }
          {% endif %}
        } catch (e) {
          jycoLog('Error handling form add to cart:', e);
        }
      }
    });
  }

  // ============================================================================
  // PRODUCT SELECTION TRACKING
  // ============================================================================

  /**
   * Setup select item event listeners
   */
  function setupSelectItemListeners() {
    document.addEventListener('click', function(e) {
      var link = e.target.closest('a[href*="/products/"]');

      if (link) {
        try {
          var productCard = link.closest('[data-product-id]') ||
                           link.closest('.product-card') ||
                           link.closest('.product-item');

          if (productCard) {
            var productId = productCard.getAttribute('data-product-id');
            var productTitle = productCard.getAttribute('data-product-title') ||
                             (productCard.querySelector('.product-title') || {}).textContent;
            var productPrice = productCard.getAttribute('data-product-price');
            var productVendor = productCard.getAttribute('data-product-vendor');
            var listName = productCard.getAttribute('data-list-name') || getPageType();
            var productIndex = productCard.getAttribute('data-product-index');

            if (productId) {
              var item = {
                item_id: productId,
                item_name: escapeString(productTitle),
                item_list_name: listName
              };

              if (productPrice) {
                item.price = safeNumber(productPrice);
              }

              if (productVendor) {
                item.item_brand = escapeString(productVendor);
              }

              if (productIndex) {
                item.index = parseInt(productIndex);
              }

              window.dataLayer.push({
                event: 'select_item',
                ecommerce: {
                  item_list_name: listName,
                  items: [item]
                }
              });

              jycoLog('Select item pushed', item);
            }
          }
        } catch (e) {
          jycoLog('Error pushing select_item:', e);
        }
      }
    });
  }

  // ============================================================================
  // INITIALIZATION
  // ============================================================================

  /**
   * Initialize on page load
   */
  async function initialize() {
    jycoLog('Initializing JY/co Gold Data Layer', { page_type: getPageType() });

    // Push user data
    await pushUserData();

    // Push page view
    pushPageView();

    // Page-specific events
    {% if template contains 'collection' %}
      pushViewItemList();
    {% elsif template contains 'product' %}
      pushViewItem();
    {% elsif template contains 'search' %}
      pushSearchEvent();
    {% elsif template contains 'cart' %}
      pushViewCart();
    {% endif %}

    // Setup event listeners
    setupCartEventListeners();
    setupSelectItemListeners();

    jycoLog('JY/co Gold Data Layer initialized successfully');
  }

  // Run initialization
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initialize);
  } else {
    initialize();
  }

})();
</script>
